<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>UPS-Amazon Communication Debug Interface</title>
    <style>
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            margin: 0;
            padding: 20px;
            background-color: #f5f5f5;
        }
        .container {
            max-width: 1400px;
            margin: 0 auto;
        }
        .header {
            background: white;
            padding: 20px;
            border-radius: 8px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
            margin-bottom: 20px;
        }
        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }
        .stat-card {
            background: white;
            padding: 20px;
            border-radius: 8px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }
        .stat-title {
            font-size: 14px;
            color: #666;
            margin-bottom: 8px;
        }
        .stat-value {
            font-size: 24px;
            font-weight: bold;
            color: #333;
        }
        .filters {
            background: white;
            padding: 20px;
            border-radius: 8px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
            margin-bottom: 20px;
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 15px;
            align-items: end;
        }
        .filter-group {
            display: flex;
            flex-direction: column;
        }
        .filter-group label {
            font-size: 14px;
            color: #666;
            margin-bottom: 5px;
        }
        .filter-group select, .filter-group input {
            padding: 8px 12px;
            border: 1px solid #ddd;
            border-radius: 4px;
            font-size: 14px;
        }
        .filter-group button {
            padding: 8px 16px;
            background: #007bff;
            color: white;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            font-size: 14px;
        }
        .filter-group button:hover {
            background: #0056b3;
        }
        .logs-container {
            background: white;
            border-radius: 8px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }
        .logs-header {
            padding: 20px;
            border-bottom: 1px solid #eee;
            font-weight: 600;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        .log-entry {
            border-bottom: 1px solid #eee;
            padding: 15px 20px;
        }
        .log-entry:last-child {
            border-bottom: none;
        }
        .log-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 10px;
        }
        .log-type {
            font-weight: 600;
            color: #333;
        }
        .log-direction {
            padding: 2px 8px;
            border-radius: 12px;
            font-size: 12px;
            font-weight: 500;
        }
        .direction-incoming {
            background: #e3f2fd;
            color: #1976d2;
        }
        .direction-outgoing {
            background: #f3e5f5;
            color: #7b1fa2;
        }
        .log-status {
            padding: 2px 8px;
            border-radius: 12px;
            font-size: 12px;
            font-weight: 500;
        }
        .status-success {
            background: #e8f5e8;
            color: #2e7d32;
        }
        .status-error {
            background: #ffebee;
            color: #c62828;
        }
        .log-time {
            font-size: 12px;
            color: #666;
        }
        .log-details {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 15px;
            margin-top: 10px;
        }
        .log-payload, .log-response {
            background: #f8f9fa;
            padding: 10px;
            border-radius: 4px;
            font-size: 12px;
            font-family: 'Monaco', 'Consolas', monospace;
        }
        .log-payload pre, .log-response pre {
            margin: 0;
            white-space: pre-wrap;
            word-wrap: break-word;
        }
        .loading {
            text-align: center;
            padding: 40px;
            color: #666;
        }
        .error-message {
            background: #ffebee;
            color: #c62828;
            padding: 15px;
            border-radius: 4px;
            margin: 20px 0;
        }
        .health-status {
            padding: 4px 8px;
            border-radius: 4px;
            font-weight: 500;
            font-size: 12px;
        }
        .health-healthy {
            background: #e8f5e8;
            color: #2e7d32;
        }
        .health-warning {
            background: #fff3e0;
            color: #f57c00;
        }
        .health-critical {
            background: #ffebee;
            color: #c62828;
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>üöö UPS-Amazon Communication Debug Interface</h1>
            <p>Monitor real-time communication between UPS and Amazon services</p>
        </div>

        <div class="stats-grid">
            <div class="stat-card">
                <div class="stat-title">System Health</div>
                <div class="stat-value">
                    <span id="healthStatus">Loading...</span>
                </div>
            </div>
            <div class="stat-card">
                <div class="stat-title">Success Rate (Last Hour)</div>
                <div class="stat-value" id="successRate">Loading...</div>
            </div>
            <div class="stat-card">
                <div class="stat-title">Total Messages (24h)</div>
                <div class="stat-value" id="totalMessages">Loading...</div>
            </div>
            <div class="stat-card">
                <div class="stat-title">Avg Processing Time</div>
                <div class="stat-value" id="avgProcessingTime">Loading...</div>
            </div>
        </div>

        <div class="filters">
            <div class="filter-group">
                <label for="directionFilter">Direction</label>
                <select id="directionFilter">
                    <option value="">All Directions</option>
                    <option value="INCOMING">Incoming</option>
                    <option value="OUTGOING">Outgoing</option>
                </select>
            </div>
            <div class="filter-group">
                <label for="messageTypeFilter">Message Type</label>
                <select id="messageTypeFilter">
                    <option value="">All Types</option>
                    <option value="ShipmentCreated">ShipmentCreated</option>
                    <option value="ShipmentLoaded">ShipmentLoaded</option>
                    <option value="TruckDispatched">TruckDispatched</option>
                    <option value="TruckArrived">TruckArrived</option>
                    <option value="ShipmentDelivered">ShipmentDelivered</option>
                </select>
            </div>
            <div class="filter-group">
                <label for="successFilter">Status</label>
                <select id="successFilter">
                    <option value="">All Status</option>
                    <option value="true">Success</option>
                    <option value="false">Error</option>
                </select>
            </div>
            <div class="filter-group">
                <label for="hoursFilter">Time Range</label>
                <select id="hoursFilter">
                    <option value="1">Last Hour</option>
                    <option value="6">Last 6 Hours</option>
                    <option value="24" selected>Last 24 Hours</option>
                    <option value="72">Last 3 Days</option>
                </select>
            </div>
            <div class="filter-group">
                <button onclick="refreshLogs()">üîÑ Refresh</button>
            </div>
            <div class="filter-group">
                <button onclick="toggleAutoRefresh()">‚è±Ô∏è <span id="autoRefreshText">Enable Auto-refresh</span></button>
            </div>
        </div>

        <div class="logs-container">
            <div class="logs-header">
                <span>Communication Logs</span>
                <span id="logCount">0 messages</span>
            </div>
            <div id="logsContent" class="loading">
                Loading communication logs...
            </div>
        </div>
    </div>

    <script>
        let autoRefreshInterval;
        let autoRefreshEnabled = false;

        // Load initial data
        loadStatistics();
        loadLogs();

        function loadStatistics() {
            fetch('/api/debug/statistics')
                .then(response => response.json())
                .then(data => {
                    updateStatistics(data);
                })
                .catch(error => {
                    console.error('Error loading statistics:', error);
                });

            fetch('/api/debug/health')
                .then(response => response.json())
                .then(data => {
                    updateHealthStatus(data);
                })
                .catch(error => {
                    console.error('Error loading health status:', error);
                });
        }

        function updateStatistics(data) {
            const successStats = data.successStats || {};
            const successful = successStats.successful || 0;
            const failed = successStats.failed || 0;
            const total = successful + failed;
            
            const successRate = total > 0 ? Math.round((successful / total) * 100) : 100;
            document.getElementById('successRate').textContent = successRate + '%';
            
            const avgTime = data.averageProcessingTimeMs || 0;
            document.getElementById('avgProcessingTime').textContent = Math.round(avgTime) + 'ms';
        }

        function updateHealthStatus(data) {
            const status = data.status || 'unknown';
            const successRate = data.successRate || 0;
            const total = data.totalMessages || 0;
            
            const healthElement = document.getElementById('healthStatus');
            healthElement.innerHTML = `<span class="health-status health-${status}">${status.toUpperCase()}</span>`;
            
            document.getElementById('totalMessages').textContent = total;
        }

        function loadLogs() {
            const direction = document.getElementById('directionFilter').value;
            const messageType = document.getElementById('messageTypeFilter').value;
            const success = document.getElementById('successFilter').value;
            const hoursBack = document.getElementById('hoursFilter').value;

            const params = new URLSearchParams();
            if (direction) params.append('direction', direction);
            if (messageType) params.append('messageType', messageType);
            if (success) params.append('success', success);
            params.append('hoursBack', hoursBack);

            fetch(`/api/debug/communications?${params}`)
                .then(response => response.json())
                .then(data => {
                    displayLogs(data.logs || []);
                    document.getElementById('logCount').textContent = `${data.count || 0} messages`;
                })
                .catch(error => {
                    console.error('Error loading logs:', error);
                    document.getElementById('logsContent').innerHTML = 
                        '<div class="error-message">Error loading communication logs. Please check console for details.</div>';
                });
        }

        function displayLogs(logs) {
            const container = document.getElementById('logsContent');
            
            if (logs.length === 0) {
                container.innerHTML = '<div class="loading">No communication logs found for the selected filters.</div>';
                return;
            }

            container.innerHTML = logs.map(log => `
                <div class="log-entry">
                    <div class="log-header">
                        <div>
                            <span class="log-type">${log.messageType || 'Unknown'}</span>
                            <span class="log-direction direction-${log.direction.toLowerCase()}">${log.direction}</span>
                            <span class="log-status status-${log.success ? 'success' : 'error'}">${log.success ? 'Success' : 'Error'}</span>
                            ${log.processingTimeMs ? `<span style="color: #666; font-size: 12px;">${log.processingTimeMs}ms</span>` : ''}
                        </div>
                        <div class="log-time">
                            ${new Date(log.createdAt).toLocaleString()}
                        </div>
                    </div>
                    <div style="margin-bottom: 8px; font-size: 12px; color: #666;">
                        ${log.endpoint} ‚Ä¢ Status: ${log.statusCode || 'N/A'}
                        ${log.shipmentId ? ` ‚Ä¢ Shipment: ${log.shipmentId}` : ''}
                        ${log.truckId ? ` ‚Ä¢ Truck: ${log.truckId}` : ''}
                        ${log.warehouseId ? ` ‚Ä¢ Warehouse: ${log.warehouseId}` : ''}
                    </div>
                    <div class="log-details">
                        <div class="log-payload">
                            <strong>Request/Payload:</strong>
                            <pre>${formatJson(log.payload)}</pre>
                        </div>
                        <div class="log-response">
                            <strong>Response:</strong>
                            <pre>${formatJson(log.response)}</pre>
                        </div>
                    </div>
                </div>
            `).join('');
        }

        function formatJson(jsonString) {
            if (!jsonString) return 'N/A';
            
            try {
                const obj = JSON.parse(jsonString);
                return JSON.stringify(obj, null, 2);
            } catch (e) {
                return jsonString;
            }
        }

        function refreshLogs() {
            loadStatistics();
            loadLogs();
        }

        function toggleAutoRefresh() {
            if (autoRefreshEnabled) {
                clearInterval(autoRefreshInterval);
                autoRefreshEnabled = false;
                document.getElementById('autoRefreshText').textContent = 'Enable Auto-refresh';
            } else {
                autoRefreshInterval = setInterval(refreshLogs, 10000); // Refresh every 10 seconds
                autoRefreshEnabled = true;
                document.getElementById('autoRefreshText').textContent = 'Disable Auto-refresh';
            }
        }

        // Add event listeners for filters
        document.getElementById('directionFilter').addEventListener('change', loadLogs);
        document.getElementById('messageTypeFilter').addEventListener('change', loadLogs);
        document.getElementById('successFilter').addEventListener('change', loadLogs);
        document.getElementById('hoursFilter').addEventListener('change', loadLogs);
    </script>
</body>
</html>