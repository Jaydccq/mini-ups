<?xml version="1.0" encoding="UTF-8"?><!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd"><html xmlns="http://www.w3.org/1999/xhtml" lang="en"><head><meta http-equiv="Content-Type" content="text/html;charset=UTF-8"/><link rel="stylesheet" href="../jacoco-resources/report.css" type="text/css"/><link rel="shortcut icon" href="../jacoco-resources/report.gif" type="image/gif"/><title>TrackingService.java</title><link rel="stylesheet" href="../jacoco-resources/prettify.css" type="text/css"/><script type="text/javascript" src="../jacoco-resources/prettify.js"></script></head><body onload="window['PR_TAB_WIDTH']=4;prettyPrint()"><div class="breadcrumb" id="breadcrumb"><span class="info"><a href="../jacoco-sessions.html" class="el_session">Sessions</a></span><a href="../index.html" class="el_report">Mini UPS Backend</a> &gt; <a href="index.source.html" class="el_package">com.miniups.service</a> &gt; <span class="el_source">TrackingService.java</span></div><h1>TrackingService.java</h1><pre class="source lang-java linenums">/**
 * Package Tracking Service
 * 
 * Functionality:
 * - Generate unique UPS tracking numbers
 * - Provide package status query functionality
 * - Manage package tracking history records
 * 
 * Tracking Number Generation Rules:
 * - Format: UPS + timestamp + random number
 * - Length: Fixed 20 digits
 * - Uniqueness: Guaranteed through database constraints
 * 
 * Status Management:
 * - Real-time package status updates
 * - Record status change history
 * - Support status lookup and auditing
 * 
 * @author Mini-UPS Team
 * @version 1.0.0
 */
package com.miniups.service;

import com.miniups.model.entity.Shipment;
import com.miniups.model.entity.ShipmentStatusHistory;
import com.miniups.model.enums.ShipmentStatus;
import com.miniups.repository.ShipmentRepository;

import org.slf4j.Logger;
import org.slf4j.LoggerFactory;
import org.springframework.beans.factory.annotation.Autowired;
import org.springframework.stereotype.Service;
import org.springframework.transaction.annotation.Transactional;

import java.time.LocalDateTime;
import java.time.format.DateTimeFormatter;
import java.util.List;
import java.util.Optional;
import java.util.Random;

@Service
@Transactional
<span class="nc" id="L43">public class TrackingService {</span>
    
<span class="nc" id="L45">    private static final Logger logger = LoggerFactory.getLogger(TrackingService.class);</span>
    
    private static final String TRACKING_PREFIX = &quot;UPS&quot;;
    private static final int MAX_RETRY_ATTEMPTS = 5;
    
    @Autowired
    private ShipmentRepository shipmentRepository;
    
<span class="nc" id="L53">    private final Random random = new Random();</span>
    
    /**
     * Generate unique UPS tracking number
     * 
     * Format: UPS + YYYYMMDDHHMMSS + 4-digit random number
     * Example: UPS202401151030451234
     * 
     * @return Unique tracking number
     */
    public String generateTrackingNumber() {
<span class="nc" id="L64">        int attempts = 0;</span>
        
<span class="nc bnc" id="L66" title="All 2 branches missed.">        while (attempts &lt; MAX_RETRY_ATTEMPTS) {</span>
<span class="nc" id="L67">            String trackingNumber = createTrackingNumber();</span>
            
            // Check if tracking number already exists
<span class="nc bnc" id="L70" title="All 2 branches missed.">            if (!shipmentRepository.existsByUpsTrackingId(trackingNumber)) {</span>
<span class="nc" id="L71">                logger.info(&quot;Generated tracking number: {}&quot;, trackingNumber);</span>
<span class="nc" id="L72">                return trackingNumber;</span>
            }
            
<span class="nc" id="L75">            attempts++;</span>
<span class="nc" id="L76">            logger.warn(&quot;Tracking number collision, attempt {}: {}&quot;, attempts, trackingNumber);</span>
<span class="nc" id="L77">        }</span>
        
        // If we still have collisions after max attempts, add system timestamp
<span class="nc" id="L80">        String fallbackNumber = createTrackingNumber() + System.nanoTime() % 10000;</span>
<span class="nc" id="L81">        logger.warn(&quot;Used fallback tracking number generation: {}&quot;, fallbackNumber);</span>
<span class="nc" id="L82">        return fallbackNumber;</span>
    }
    
    /**
     * Query package information by tracking number
     * 
     * @param trackingNumber UPS tracking number
     * @return Package shipment information
     */
    @Transactional(readOnly = true)
    public Optional&lt;Shipment&gt; findByTrackingNumber(String trackingNumber) {
<span class="nc bnc" id="L93" title="All 4 branches missed.">        if (trackingNumber == null || trackingNumber.trim().isEmpty()) {</span>
<span class="nc" id="L94">            return Optional.empty();</span>
        }
        
<span class="nc" id="L97">        return shipmentRepository.findByUpsTrackingId(trackingNumber.trim());</span>
    }
    
    /**
     * Update package status
     * 
     * @param trackingNumber UPS tracking number
     * @param newStatus New status
     * @param comment Status change comment
     * @return Whether update was successful
     */
    public boolean updateShipmentStatus(String trackingNumber, ShipmentStatus newStatus, String comment) {
        try {
<span class="nc" id="L110">            Optional&lt;Shipment&gt; shipmentOpt = findByTrackingNumber(trackingNumber);</span>
            
<span class="nc bnc" id="L112" title="All 2 branches missed.">            if (shipmentOpt.isEmpty()) {</span>
<span class="nc" id="L113">                logger.warn(&quot;Shipment not found for tracking number: {}&quot;, trackingNumber);</span>
<span class="nc" id="L114">                return false;</span>
            }
            
<span class="nc" id="L117">            Shipment shipment = shipmentOpt.get();</span>
<span class="nc" id="L118">            ShipmentStatus oldStatus = shipment.getStatus();</span>
            
            // Validate status transition
<span class="nc bnc" id="L121" title="All 2 branches missed.">            if (!isValidStatusTransition(oldStatus, newStatus)) {</span>
<span class="nc" id="L122">                logger.warn(&quot;Invalid status transition from {} to {} for tracking number: {}&quot;, </span>
                           oldStatus, newStatus, trackingNumber);
<span class="nc" id="L124">                return false;</span>
            }
            
            // Update status
<span class="nc" id="L128">            shipment.updateStatus(newStatus);</span>
            
            // Add status history entry with comment
<span class="nc" id="L131">            ShipmentStatusHistory history = new ShipmentStatusHistory();</span>
<span class="nc" id="L132">            history.setShipment(shipment);</span>
<span class="nc" id="L133">            history.setStatus(newStatus);</span>
<span class="nc" id="L134">            history.setTimestamp(LocalDateTime.now());</span>
<span class="nc" id="L135">            history.setNotes(comment);</span>
            
<span class="nc" id="L137">            shipment.getStatusHistory().add(history);</span>
            
            // Update delivery time if delivered
<span class="nc bnc" id="L140" title="All 2 branches missed.">            if (newStatus == ShipmentStatus.DELIVERED) {</span>
<span class="nc" id="L141">                shipment.setActualDelivery(LocalDateTime.now());</span>
            }
            
<span class="nc" id="L144">            shipmentRepository.save(shipment);</span>
            
<span class="nc" id="L146">            logger.info(&quot;Updated shipment {} status from {} to {}&quot;, </span>
                       trackingNumber, oldStatus, newStatus);
            
<span class="nc" id="L149">            return true;</span>
            
<span class="nc" id="L151">        } catch (Exception e) {</span>
<span class="nc" id="L152">            logger.error(&quot;Error updating shipment status for tracking number: &quot; + trackingNumber, e);</span>
<span class="nc" id="L153">            return false;</span>
        }
    }
    
    /**
     * Get package status history
     * 
     * @param trackingNumber UPS tracking number
     * @return Status history list
     */
    @Transactional(readOnly = true)
    public List&lt;ShipmentStatusHistory&gt; getStatusHistory(String trackingNumber) {
<span class="nc" id="L165">        Optional&lt;Shipment&gt; shipmentOpt = findByTrackingNumber(trackingNumber);</span>
        
<span class="nc bnc" id="L167" title="All 2 branches missed.">        if (shipmentOpt.isPresent()) {</span>
<span class="nc" id="L168">            return shipmentOpt.get().getStatusHistory();</span>
        }
        
<span class="nc" id="L171">        return List.of();</span>
    }
    
    /**
     * Check if tracking number format is valid
     * 
     * @param trackingNumber Tracking number
     * @return Whether it's valid
     */
    public boolean isValidTrackingNumberFormat(String trackingNumber) {
<span class="nc bnc" id="L181" title="All 4 branches missed.">        if (trackingNumber == null || trackingNumber.trim().isEmpty()) {</span>
<span class="nc" id="L182">            return false;</span>
        }
        
<span class="nc" id="L185">        String trimmed = trackingNumber.trim();</span>
        
        // Check prefix
<span class="nc bnc" id="L188" title="All 2 branches missed.">        if (!trimmed.startsWith(TRACKING_PREFIX)) {</span>
<span class="nc" id="L189">            return false;</span>
        }
        
        // Check minimum length (UPS + 14 digits + 4 random = 21 chars minimum)
<span class="nc bnc" id="L193" title="All 2 branches missed.">        if (trimmed.length() &lt; 21) {</span>
<span class="nc" id="L194">            return false;</span>
        }
        
        // Check that part after prefix contains only digits
<span class="nc" id="L198">        String numberPart = trimmed.substring(TRACKING_PREFIX.length());</span>
<span class="nc" id="L199">        return numberPart.matches(&quot;\\d+&quot;);</span>
    }
    
    /**
     * Get all packages for specified user
     * 
     * @param userId User ID
     * @return All shipment orders for the user
     */
    @Transactional(readOnly = true)
    public List&lt;Shipment&gt; getUserShipments(Long userId) {
<span class="nc" id="L210">        return shipmentRepository.findByUserIdOrderByCreatedAtDesc(userId);</span>
    }
    
    // Private helper methods
    
    private String createTrackingNumber() {
        // Get current timestamp
<span class="nc" id="L217">        String timestamp = LocalDateTime.now().format(DateTimeFormatter.ofPattern(&quot;yyyyMMddHHmmss&quot;));</span>
        
        // Generate 4-digit random number
<span class="nc" id="L220">        int randomNum = 1000 + random.nextInt(9000);</span>
        
<span class="nc" id="L222">        return TRACKING_PREFIX + timestamp + randomNum;</span>
    }
    
    private boolean isValidStatusTransition(ShipmentStatus fromStatus, ShipmentStatus toStatus) {
        // Define valid state transitions
<span class="nc bnc" id="L227" title="All 9 branches missed.">        switch (fromStatus) {</span>
            case CREATED:
<span class="nc bnc" id="L229" title="All 4 branches missed.">                return toStatus == ShipmentStatus.PICKED_UP || toStatus == ShipmentStatus.CANCELLED;</span>
                
            case PICKED_UP:
<span class="nc bnc" id="L232" title="All 4 branches missed.">                return toStatus == ShipmentStatus.IN_TRANSIT || toStatus == ShipmentStatus.CANCELLED;</span>
                
            case IN_TRANSIT:
<span class="nc bnc" id="L235" title="All 6 branches missed.">                return toStatus == ShipmentStatus.OUT_FOR_DELIVERY || </span>
                       toStatus == ShipmentStatus.CANCELLED ||
                       toStatus == ShipmentStatus.EXCEPTION;
                
            case OUT_FOR_DELIVERY:
<span class="nc bnc" id="L240" title="All 6 branches missed.">                return toStatus == ShipmentStatus.DELIVERED || </span>
                       toStatus == ShipmentStatus.DELIVERY_ATTEMPTED ||
                       toStatus == ShipmentStatus.EXCEPTION;
                
            case DELIVERY_ATTEMPTED:
<span class="nc bnc" id="L245" title="All 6 branches missed.">                return toStatus == ShipmentStatus.OUT_FOR_DELIVERY || </span>
                       toStatus == ShipmentStatus.DELIVERED ||
                       toStatus == ShipmentStatus.RETURNED;
                
            case DELIVERED:
                // Delivered is typically a final state, but allow for corrections
<span class="nc bnc" id="L251" title="All 2 branches missed.">                return toStatus == ShipmentStatus.EXCEPTION;</span>
                
            case CANCELLED:
            case RETURNED:
                // These are final states
<span class="nc" id="L256">                return false;</span>
                
            case EXCEPTION:
                // From exception, can go to most states depending on resolution
<span class="nc bnc" id="L260" title="All 2 branches missed.">                return toStatus != ShipmentStatus.CREATED;</span>
                
            default:
<span class="nc" id="L263">                return false;</span>
        }
    }
}
</pre><div class="footer"><span class="right">Created with <a href="http://www.jacoco.org/jacoco">JaCoCo</a> 0.8.11.202310140853</span></div></body></html>