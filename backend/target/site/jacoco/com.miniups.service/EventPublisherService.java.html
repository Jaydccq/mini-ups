<?xml version="1.0" encoding="UTF-8"?><!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd"><html xmlns="http://www.w3.org/1999/xhtml" lang="en"><head><meta http-equiv="Content-Type" content="text/html;charset=UTF-8"/><link rel="stylesheet" href="../jacoco-resources/report.css" type="text/css"/><link rel="shortcut icon" href="../jacoco-resources/report.gif" type="image/gif"/><title>EventPublisherService.java</title><link rel="stylesheet" href="../jacoco-resources/prettify.css" type="text/css"/><script type="text/javascript" src="../jacoco-resources/prettify.js"></script></head><body onload="window['PR_TAB_WIDTH']=4;prettyPrint()"><div class="breadcrumb" id="breadcrumb"><span class="info"><a href="../jacoco-sessions.html" class="el_session">Sessions</a></span><a href="../index.html" class="el_report">Mini UPS Backend</a> &gt; <a href="index.source.html" class="el_package">com.miniups.service</a> &gt; <span class="el_source">EventPublisherService.java</span></div><h1>EventPublisherService.java</h1><pre class="source lang-java linenums">package com.miniups.service;

import com.miniups.config.RabbitMQConfig;
import com.miniups.model.event.AuditLogPayload;
import com.miniups.model.event.BusinessEvent;
import com.miniups.model.event.NotificationPayload;
import com.miniups.model.event.ShipmentCreationPayload;
import lombok.RequiredArgsConstructor;
import org.slf4j.Logger;
import org.slf4j.LoggerFactory;
import org.springframework.amqp.rabbit.core.RabbitTemplate;
import org.springframework.beans.factory.annotation.Value;
import org.springframework.stereotype.Service;

/**
 * Event Publisher Service
 * 
 * Centralized service for publishing business events to RabbitMQ.
 * This service provides type-safe methods for publishing different
 * types of events and handles the technical details of message routing.
 * 
 * Key Features:
 * - Type-safe event publishing
 * - Automatic routing key generation
 * - Correlation ID support for request tracing
 * - Error handling and logging
 * - Consistent event metadata
 * 
 * @author Mini-UPS Development Team
 * @version 1.0
 * @since 2024
 */
@Service
public class EventPublisherService {
<span class="nc" id="L35">    private static final Logger log = LoggerFactory.getLogger(EventPublisherService.class);</span>
    private final RabbitTemplate rabbitTemplate;
    
<span class="nc" id="L38">    public EventPublisherService(RabbitTemplate rabbitTemplate) {</span>
<span class="nc" id="L39">        this.rabbitTemplate = rabbitTemplate;</span>
<span class="nc" id="L40">    }</span>

    @Value(&quot;${spring.application.name:mini-ups-backend}&quot;)
    private String sourceService;

    /**
     * Publish a shipment creation event
     * 
     * @param payload The shipment creation data
     * @param correlationId Optional correlation ID for request tracing
     */
    public void publishShipmentCreationEvent(ShipmentCreationPayload payload, String correlationId) {
        try {
<span class="nc" id="L53">            BusinessEvent&lt;ShipmentCreationPayload&gt; event = BusinessEvent.create(</span>
                    RabbitMQConfig.SHIPMENT_CREATE_ROUTING_KEY,
                    sourceService,
                    payload,
                    correlationId
            );

<span class="nc" id="L60">            rabbitTemplate.convertAndSend(</span>
                    RabbitMQConfig.TOPIC_EXCHANGE_NAME,
                    RabbitMQConfig.SHIPMENT_CREATE_ROUTING_KEY,
                    event
            );

<span class="nc" id="L66">            log.info(&quot;Published shipment creation event: {} (correlationId: {})&quot;, </span>
<span class="nc" id="L67">                    event.getEventId(), correlationId);</span>

<span class="nc" id="L69">        } catch (Exception e) {</span>
<span class="nc" id="L70">            log.error(&quot;Failed to publish shipment creation event for payload: {}&quot;, payload, e);</span>
<span class="nc" id="L71">            throw new RuntimeException(&quot;Failed to publish shipment creation event&quot;, e);</span>
<span class="nc" id="L72">        }</span>
<span class="nc" id="L73">    }</span>

    /**
     * Publish an audit log event
     * 
     * @param payload The audit log data
     * @param correlationId Optional correlation ID for request tracing
     */
    public void publishAuditLogEvent(AuditLogPayload payload, String correlationId) {
        try {
<span class="nc" id="L83">            BusinessEvent&lt;AuditLogPayload&gt; event = BusinessEvent.create(</span>
                    RabbitMQConfig.AUDIT_LOG_ROUTING_KEY,
                    sourceService,
                    payload,
                    correlationId
            );

<span class="nc" id="L90">            rabbitTemplate.convertAndSend(</span>
                    RabbitMQConfig.TOPIC_EXCHANGE_NAME,
                    RabbitMQConfig.AUDIT_LOG_ROUTING_KEY,
                    event
            );

<span class="nc" id="L96">            log.debug(&quot;Published audit log event: {} for operation: {}&quot;, </span>
<span class="nc" id="L97">                    event.getEventId(), payload.getOperationType());</span>

<span class="nc" id="L99">        } catch (Exception e) {</span>
<span class="nc" id="L100">            log.error(&quot;Failed to publish audit log event for operation: {}&quot;, </span>
<span class="nc" id="L101">                    payload.getOperationType(), e);</span>
            // Don't throw exception for audit logs to avoid impacting main business flow
<span class="nc" id="L103">        }</span>
<span class="nc" id="L104">    }</span>

    /**
     * Publish a notification event
     * 
     * @param payload The notification data
     * @param correlationId Optional correlation ID for request tracing
     */
    public void publishNotificationEvent(NotificationPayload payload, String correlationId) {
        try {
            // Determine routing key based on notification type and priority
<span class="nc" id="L115">            String routingKey = generateNotificationRoutingKey(payload);</span>

<span class="nc" id="L117">            BusinessEvent&lt;NotificationPayload&gt; event = BusinessEvent.create(</span>
                    routingKey,
                    sourceService,
                    payload,
                    correlationId
            );

<span class="nc" id="L124">            rabbitTemplate.convertAndSend(</span>
                    RabbitMQConfig.TOPIC_EXCHANGE_NAME,
                    routingKey,
                    event
            );

<span class="nc" id="L130">            log.info(&quot;Published notification event: {} for user: {} (types: {})&quot;, </span>
<span class="nc" id="L131">                    event.getEventId(), payload.getRecipientUserId(), payload.getNotificationTypes());</span>

<span class="nc" id="L133">        } catch (Exception e) {</span>
<span class="nc" id="L134">            log.error(&quot;Failed to publish notification event for user: {}&quot;, </span>
<span class="nc" id="L135">                    payload.getRecipientUserId(), e);</span>
            // Don't throw exception for notifications to avoid impacting main business flow
<span class="nc" id="L137">        }</span>
<span class="nc" id="L138">    }</span>

    /**
     * Publish a shipment status update event
     * 
     * @param shipmentId The ID of the shipment
     * @param oldStatus The previous status
     * @param newStatus The new status
     * @param correlationId Optional correlation ID for request tracing
     */
    public void publishShipmentStatusUpdateEvent(Long shipmentId, String oldStatus, 
                                                String newStatus, String correlationId) {
        try {
            // Create a simple status update payload
<span class="nc" id="L152">            var statusUpdatePayload = new java.util.HashMap&lt;String, Object&gt;();</span>
<span class="nc" id="L153">            statusUpdatePayload.put(&quot;shipmentId&quot;, shipmentId);</span>
<span class="nc" id="L154">            statusUpdatePayload.put(&quot;oldStatus&quot;, oldStatus);</span>
<span class="nc" id="L155">            statusUpdatePayload.put(&quot;newStatus&quot;, newStatus);</span>
<span class="nc" id="L156">            statusUpdatePayload.put(&quot;timestamp&quot;, java.time.Instant.now());</span>

<span class="nc" id="L158">            BusinessEvent&lt;Object&gt; event = BusinessEvent.create(</span>
                    RabbitMQConfig.SHIPMENT_STATUS_ROUTING_KEY,
                    sourceService,
                    statusUpdatePayload,
                    correlationId
            );

<span class="nc" id="L165">            rabbitTemplate.convertAndSend(</span>
                    RabbitMQConfig.TOPIC_EXCHANGE_NAME,
                    RabbitMQConfig.SHIPMENT_STATUS_ROUTING_KEY,
                    event
            );

<span class="nc" id="L171">            log.info(&quot;Published shipment status update event: {} for shipment: {} ({} -&gt; {})&quot;, </span>
<span class="nc" id="L172">                    event.getEventId(), shipmentId, oldStatus, newStatus);</span>

<span class="nc" id="L174">        } catch (Exception e) {</span>
<span class="nc" id="L175">            log.error(&quot;Failed to publish shipment status update event for shipment: {}&quot;, </span>
                    shipmentId, e);
            // Don't throw exception to avoid impacting main business flow
<span class="nc" id="L178">        }</span>
<span class="nc" id="L179">    }</span>

    /**
     * Publish a user registration event
     * 
     * @param userId The ID of the newly registered user
     * @param userEmail The email of the user
     * @param correlationId Optional correlation ID for request tracing
     */
    public void publishUserRegisteredEvent(Long userId, String userEmail, String correlationId) {
        try {
<span class="nc" id="L190">            var userRegistrationPayload = new java.util.HashMap&lt;String, Object&gt;();</span>
<span class="nc" id="L191">            userRegistrationPayload.put(&quot;userId&quot;, userId);</span>
<span class="nc" id="L192">            userRegistrationPayload.put(&quot;userEmail&quot;, userEmail);</span>
<span class="nc" id="L193">            userRegistrationPayload.put(&quot;registrationTime&quot;, java.time.Instant.now());</span>

<span class="nc" id="L195">            BusinessEvent&lt;Object&gt; event = BusinessEvent.create(</span>
                    RabbitMQConfig.USER_REGISTERED_ROUTING_KEY,
                    sourceService,
                    userRegistrationPayload,
                    correlationId
            );

<span class="nc" id="L202">            rabbitTemplate.convertAndSend(</span>
                    RabbitMQConfig.TOPIC_EXCHANGE_NAME,
                    RabbitMQConfig.USER_REGISTERED_ROUTING_KEY,
                    event
            );

<span class="nc" id="L208">            log.info(&quot;Published user registration event: {} for user: {}&quot;, </span>
<span class="nc" id="L209">                    event.getEventId(), userId);</span>

<span class="nc" id="L211">        } catch (Exception e) {</span>
<span class="nc" id="L212">            log.error(&quot;Failed to publish user registration event for user: {}&quot;, userId, e);</span>
            // Don't throw exception to avoid impacting main business flow
<span class="nc" id="L214">        }</span>
<span class="nc" id="L215">    }</span>

    /**
     * Publish a truck dispatch event
     * 
     * @param truckId The ID of the truck being dispatched
     * @param shipmentIds List of shipment IDs assigned to the truck
     * @param correlationId Optional correlation ID for request tracing
     */
    public void publishTruckDispatchEvent(Long truckId, java.util.List&lt;Long&gt; shipmentIds, 
                                        String correlationId) {
        try {
<span class="nc" id="L227">            var truckDispatchPayload = new java.util.HashMap&lt;String, Object&gt;();</span>
<span class="nc" id="L228">            truckDispatchPayload.put(&quot;truckId&quot;, truckId);</span>
<span class="nc" id="L229">            truckDispatchPayload.put(&quot;shipmentIds&quot;, shipmentIds);</span>
<span class="nc" id="L230">            truckDispatchPayload.put(&quot;dispatchTime&quot;, java.time.Instant.now());</span>

<span class="nc" id="L232">            BusinessEvent&lt;Object&gt; event = BusinessEvent.create(</span>
                    RabbitMQConfig.TRUCK_DISPATCH_ROUTING_KEY,
                    sourceService,
                    truckDispatchPayload,
                    correlationId
            );

<span class="nc" id="L239">            rabbitTemplate.convertAndSend(</span>
                    RabbitMQConfig.TOPIC_EXCHANGE_NAME,
                    RabbitMQConfig.TRUCK_DISPATCH_ROUTING_KEY,
                    event
            );

<span class="nc" id="L245">            log.info(&quot;Published truck dispatch event: {} for truck: {} with {} shipments&quot;, </span>
<span class="nc" id="L246">                    event.getEventId(), truckId, shipmentIds.size());</span>

<span class="nc" id="L248">        } catch (Exception e) {</span>
<span class="nc" id="L249">            log.error(&quot;Failed to publish truck dispatch event for truck: {}&quot;, truckId, e);</span>
            // Don't throw exception to avoid impacting main business flow
<span class="nc" id="L251">        }</span>
<span class="nc" id="L252">    }</span>

    /**
     * Generate appropriate routing key for notification events
     * Based on notification type and priority
     */
    private String generateNotificationRoutingKey(NotificationPayload payload) {
<span class="nc" id="L259">        String baseKey = &quot;notification&quot;;</span>
        
<span class="nc bnc" id="L261" title="All 2 branches missed.">        if (payload.getPriority() == NotificationPayload.Priority.URGENT) {</span>
<span class="nc" id="L262">            baseKey += &quot;.urgent&quot;;</span>
<span class="nc bnc" id="L263" title="All 2 branches missed.">        } else if (payload.getPriority() == NotificationPayload.Priority.HIGH) {</span>
<span class="nc" id="L264">            baseKey += &quot;.high&quot;;</span>
        } else {
<span class="nc" id="L266">            baseKey += &quot;.normal&quot;;</span>
        }

<span class="nc bnc" id="L269" title="All 2 branches missed.">        if (payload.getCategory() != null) {</span>
<span class="nc" id="L270">            baseKey += &quot;.&quot; + payload.getCategory();</span>
        }

<span class="nc" id="L273">        return baseKey;</span>
    }
}
</pre><div class="footer"><span class="right">Created with <a href="http://www.jacoco.org/jacoco">JaCoCo</a> 0.8.11.202310140853</span></div></body></html>