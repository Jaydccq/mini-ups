<?xml version="1.0" encoding="UTF-8"?><!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd"><html xmlns="http://www.w3.org/1999/xhtml" lang="en"><head><meta http-equiv="Content-Type" content="text/html;charset=UTF-8"/><link rel="stylesheet" href="../jacoco-resources/report.css" type="text/css"/><link rel="shortcut icon" href="../jacoco-resources/report.gif" type="image/gif"/><title>ShipmentService.java</title><link rel="stylesheet" href="../jacoco-resources/prettify.css" type="text/css"/><script type="text/javascript" src="../jacoco-resources/prettify.js"></script></head><body onload="window['PR_TAB_WIDTH']=4;prettyPrint()"><div class="breadcrumb" id="breadcrumb"><span class="info"><a href="../jacoco-sessions.html" class="el_session">Sessions</a></span><a href="../index.html" class="el_report">Mini UPS Backend</a> &gt; <a href="index.source.html" class="el_package">com.miniups.service</a> &gt; <span class="el_source">ShipmentService.java</span></div><h1>ShipmentService.java</h1><pre class="source lang-java linenums">/**
 * Shipment Service
 * 
 * 功能说明：
 * - 提供运单创建、查询、更新的核心业务逻辑
 * - 集成Amazon订单和UPS运输服务
 * - 管理运单生命周期和状态变更
 * 
 * 主要功能：
 * - 创建新运单
 * - 查询运单信息
 * - 更新运单状态
 * - 运单分配和调度
 * 
 * 依赖服务：
 * - TrackingService: 追踪号生成和状态管理
 * - TruckManagementService: 车辆分配
 * - UserService: 用户信息验证
 * 
 * @author Mini-UPS Team
 * @version 1.0.0
 */
package com.miniups.service;

import com.miniups.model.dto.shipment.CreateShipmentDto;
import com.miniups.model.entity.Shipment;
import com.miniups.model.entity.User;
import com.miniups.model.entity.Truck;
import com.miniups.model.enums.ShipmentStatus;
import com.miniups.model.enums.UserRole;
import com.miniups.repository.ShipmentRepository;
import com.miniups.repository.UserRepository;

import org.slf4j.Logger;
import org.slf4j.LoggerFactory;
import org.springframework.beans.factory.annotation.Autowired;
import org.springframework.stereotype.Service;
import org.springframework.transaction.annotation.Transactional;

import java.time.LocalDateTime;
import java.util.List;
import java.util.Optional;

@Service
@Transactional
<span class="nc" id="L46">public class ShipmentService {</span>
    
<span class="nc" id="L48">    private static final Logger logger = LoggerFactory.getLogger(ShipmentService.class);</span>
    
    @Autowired
    private ShipmentRepository shipmentRepository;
    
    @Autowired
    private UserRepository userRepository;
    
    @Autowired
    private TrackingService trackingService;
    
    @Autowired
    private TruckManagementService truckManagementService;
    
    /**
     * 创建新运单
     * 
     * @param createShipmentDto 运单创建请求
     * @return 创建的运单实体
     */
    public Shipment createShipment(CreateShipmentDto createShipmentDto) {
        try {
<span class="nc" id="L70">            logger.info(&quot;Creating shipment for customer: {}&quot;, createShipmentDto.getCustomerName());</span>
            
            // 1. 获取或创建用户
<span class="nc" id="L73">            User customer = getOrCreateCustomer(createShipmentDto);</span>
            
            // 2. 生成追踪号
<span class="nc" id="L76">            String trackingNumber = trackingService.generateTrackingNumber();</span>
            
            // 3. 创建运单实体
<span class="nc" id="L79">            Shipment shipment = new Shipment();</span>
<span class="nc" id="L80">            shipment.setUpsTrackingId(trackingNumber);</span>
<span class="nc" id="L81">            shipment.setShipmentId(createShipmentDto.getShipmentId());</span>
<span class="nc" id="L82">            shipment.setUser(customer);</span>
<span class="nc" id="L83">            shipment.setOriginX(createShipmentDto.getOriginX());</span>
<span class="nc" id="L84">            shipment.setOriginY(createShipmentDto.getOriginY());</span>
<span class="nc" id="L85">            shipment.setDestX(createShipmentDto.getDestX());</span>
<span class="nc" id="L86">            shipment.setDestY(createShipmentDto.getDestY());</span>
<span class="nc" id="L87">            shipment.setWeight(createShipmentDto.getWeight());</span>
<span class="nc" id="L88">            shipment.setStatus(ShipmentStatus.CREATED);</span>
<span class="nc" id="L89">            shipment.setCreatedAt(LocalDateTime.now());</span>
<span class="nc" id="L90">            shipment.setUpdatedAt(LocalDateTime.now());</span>
            
            // 4. 分配车辆
            try {
<span class="nc" id="L94">                Truck assignedTruck = truckManagementService.assignOptimalTruck(</span>
<span class="nc" id="L95">                    createShipmentDto.getOriginX(),</span>
<span class="nc" id="L96">                    createShipmentDto.getOriginY(),</span>
<span class="nc" id="L97">                    1 // 默认包裹数量</span>
                );
                
<span class="nc bnc" id="L100" title="All 2 branches missed.">                if (assignedTruck != null) {</span>
<span class="nc" id="L101">                    shipment.setTruck(assignedTruck);</span>
<span class="nc" id="L102">                    shipment.setStatus(ShipmentStatus.TRUCK_DISPATCHED);</span>
<span class="nc" id="L103">                    logger.info(&quot;Assigned truck {} to shipment {}&quot;, assignedTruck.getLicensePlate(), trackingNumber);</span>
                }
<span class="nc" id="L105">            } catch (Exception e) {</span>
<span class="nc" id="L106">                logger.warn(&quot;Failed to assign truck to shipment {}: {}&quot;, trackingNumber, e.getMessage());</span>
                // 继续处理，稍后可以手动分配车辆
<span class="nc" id="L108">            }</span>
            
            // 5. 保存运单
<span class="nc" id="L111">            Shipment savedShipment = shipmentRepository.save(shipment);</span>
            
            // 6. 记录状态历史
<span class="nc" id="L114">            trackingService.updateShipmentStatus(trackingNumber, savedShipment.getStatus(), &quot;Shipment created&quot;);</span>
            
<span class="nc" id="L116">            logger.info(&quot;Successfully created shipment: {}&quot;, trackingNumber);</span>
<span class="nc" id="L117">            return savedShipment;</span>
            
<span class="nc" id="L119">        } catch (Exception e) {</span>
<span class="nc" id="L120">            logger.error(&quot;Failed to create shipment for customer {}: {}&quot;, </span>
<span class="nc" id="L121">                createShipmentDto.getCustomerName(), e.getMessage(), e);</span>
<span class="nc" id="L122">            throw new RuntimeException(&quot;Failed to create shipment: &quot; + e.getMessage(), e);</span>
        }
    }
    
    /**
     * 根据追踪号查询运单
     * 
     * @param trackingNumber UPS追踪号
     * @return 运单信息
     */
    public Optional&lt;Shipment&gt; findByTrackingNumber(String trackingNumber) {
        try {
<span class="nc" id="L134">            return shipmentRepository.findByUpsTrackingId(trackingNumber);</span>
<span class="nc" id="L135">        } catch (Exception e) {</span>
<span class="nc" id="L136">            logger.error(&quot;Error finding shipment by tracking number {}: {}&quot;, trackingNumber, e.getMessage());</span>
<span class="nc" id="L137">            return Optional.empty();</span>
        }
    }
    
    /**
     * 查询所有运单
     * 
     * @return 运单列表
     */
    public List&lt;Shipment&gt; findAllShipments() {
<span class="nc" id="L147">        return shipmentRepository.findAll();</span>
    }
    
    /**
     * 根据状态查询运单
     * 
     * @param status 运单状态
     * @return 符合条件的运单列表
     */
    public List&lt;Shipment&gt; findByStatus(ShipmentStatus status) {
<span class="nc" id="L157">        return shipmentRepository.findByStatus(status);</span>
    }
    
    /**
     * 更新运单状态
     * 
     * @param trackingNumber 追踪号
     * @param newStatus 新状态
     * @param notes 备注
     */
    public void updateShipmentStatus(String trackingNumber, ShipmentStatus newStatus, String notes) {
<span class="nc" id="L168">        Optional&lt;Shipment&gt; shipmentOpt = findByTrackingNumber(trackingNumber);</span>
<span class="nc bnc" id="L169" title="All 2 branches missed.">        if (shipmentOpt.isPresent()) {</span>
<span class="nc" id="L170">            Shipment shipment = shipmentOpt.get();</span>
<span class="nc" id="L171">            shipment.setStatus(newStatus);</span>
<span class="nc" id="L172">            shipment.setUpdatedAt(LocalDateTime.now());</span>
<span class="nc" id="L173">            shipmentRepository.save(shipment);</span>
            
            // 更新状态历史
<span class="nc" id="L176">            trackingService.updateShipmentStatus(trackingNumber, newStatus, notes);</span>
            
<span class="nc" id="L178">            logger.info(&quot;Updated shipment {} status to {}&quot;, trackingNumber, newStatus);</span>
<span class="nc" id="L179">        } else {</span>
<span class="nc" id="L180">            logger.warn(&quot;Shipment not found for tracking number: {}&quot;, trackingNumber);</span>
        }
<span class="nc" id="L182">    }</span>
    
    /**
     * 获取或创建客户用户
     * 
     * @param dto 运单创建请求
     * @return 客户用户实体
     */
    private User getOrCreateCustomer(CreateShipmentDto dto) {
        // 先尝试根据客户ID查找
<span class="nc bnc" id="L192" title="All 2 branches missed.">        if (dto.getCustomerId() != null) {</span>
<span class="nc" id="L193">            Optional&lt;User&gt; existingUser = userRepository.findByUsername(dto.getCustomerId());</span>
<span class="nc bnc" id="L194" title="All 2 branches missed.">            if (existingUser.isPresent()) {</span>
<span class="nc" id="L195">                return existingUser.get();</span>
            }
        }
        
        // 根据邮箱查找
<span class="nc" id="L200">        Optional&lt;User&gt; userByEmail = userRepository.findByEmail(dto.getCustomerEmail());</span>
<span class="nc bnc" id="L201" title="All 2 branches missed.">        if (userByEmail.isPresent()) {</span>
<span class="nc" id="L202">            return userByEmail.get();</span>
        }
        
        // 创建新用户
<span class="nc" id="L206">        User newUser = new User();</span>
<span class="nc bnc" id="L207" title="All 2 branches missed.">        newUser.setUsername(dto.getCustomerId() != null ? dto.getCustomerId() : </span>
<span class="nc" id="L208">                          &quot;customer_&quot; + System.currentTimeMillis());</span>
<span class="nc" id="L209">        newUser.setEmail(dto.getCustomerEmail());</span>
        // 分离姓名为 firstName 和 lastName
<span class="nc" id="L211">        String[] nameParts = dto.getCustomerName().split(&quot; &quot;, 2);</span>
<span class="nc" id="L212">        newUser.setFirstName(nameParts[0]);</span>
<span class="nc bnc" id="L213" title="All 2 branches missed.">        if (nameParts.length &gt; 1) {</span>
<span class="nc" id="L214">            newUser.setLastName(nameParts[1]);</span>
        }
<span class="nc" id="L216">        newUser.setRole(UserRole.USER);</span>
<span class="nc" id="L217">        newUser.setPassword(&quot;$2a$10$defaultPassword&quot;); // 默认密码，需要用户重置</span>
<span class="nc" id="L218">        newUser.setEnabled(true);</span>
<span class="nc" id="L219">        newUser.setCreatedAt(LocalDateTime.now());</span>
        
<span class="nc" id="L221">        return userRepository.save(newUser);</span>
    }
}
</pre><div class="footer"><span class="right">Created with <a href="http://www.jacoco.org/jacoco">JaCoCo</a> 0.8.11.202310140853</span></div></body></html>