<?xml version="1.0" encoding="UTF-8"?><!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd"><html xmlns="http://www.w3.org/1999/xhtml" lang="en"><head><meta http-equiv="Content-Type" content="text/html;charset=UTF-8"/><link rel="stylesheet" href="../jacoco-resources/report.css" type="text/css"/><link rel="shortcut icon" href="../jacoco-resources/report.gif" type="image/gif"/><title>UserController.java</title><link rel="stylesheet" href="../jacoco-resources/prettify.css" type="text/css"/><script type="text/javascript" src="../jacoco-resources/prettify.js"></script></head><body onload="window['PR_TAB_WIDTH']=4;prettyPrint()"><div class="breadcrumb" id="breadcrumb"><span class="info"><a href="../jacoco-sessions.html" class="el_session">Sessions</a></span><a href="../index.html" class="el_report">Mini UPS Backend</a> &gt; <a href="index.source.html" class="el_package">com.miniups.controller</a> &gt; <span class="el_source">UserController.java</span></div><h1>UserController.java</h1><pre class="source lang-java linenums">/**
 * User Management Controller
 * 
 * Features:
 * - Provides API endpoints for user information query and management
 * - Supports user information updates and status management
 * - Provides admin user management functionality
 * - Uses unified exception handling through GlobalExceptionHandler
 * 
 * API Endpoints:
 * - GET /api/users/profile: Get current user information
 * - PUT /api/users/profile: Update current user information
 * - GET /api/users/{id}: Get specified user information
 * - GET /api/users: Get user list (admin)
 * - POST /api/users: Create new user (admin)
 * - PUT /api/users/{id}: Update user information (admin)
 * - DELETE /api/users/{id}: Delete user (admin)
 * - POST /api/users/{id}/enable: Enable user (admin)
 * - GET /api/users/{id}/public: Get user public profile
 * 
 * Permission Control:
 * - Regular users can only view and modify their own information
 * - Admins can manage all users
 * - Sensitive operations require ADMIN role
 * 
 * @author Mini-UPS Team
 * @version 1.0.0
 */
package com.miniups.controller;

import com.miniups.model.dto.user.CreateUserDto;
import com.miniups.model.dto.user.UpdateUserDto;
import com.miniups.model.dto.user.UserDto;
import com.miniups.model.dto.common.ApiResponse;
import com.miniups.model.enums.UserRole;
import com.miniups.service.UserService;
import jakarta.validation.Valid;
import org.slf4j.Logger;
import org.slf4j.LoggerFactory;
import org.springframework.data.domain.Page;
import org.springframework.data.domain.Pageable;
import org.springframework.data.domain.Sort;
import org.springframework.data.web.PageableDefault;
import org.springframework.http.ResponseEntity;
import org.springframework.security.access.prepost.PreAuthorize;
import org.springframework.security.core.Authentication;
import org.springframework.security.core.context.SecurityContextHolder;
import org.springframework.web.bind.annotation.*;

import java.util.HashMap;
import java.util.List;
import java.util.Map;

@RestController
@RequestMapping(&quot;/api/users&quot;)
public class UserController {
    
<span class="fc" id="L58">    private static final Logger logger = LoggerFactory.getLogger(UserController.class);</span>
    
    private final UserService userService;
    
<span class="fc" id="L62">    public UserController(UserService userService) {</span>
<span class="fc" id="L63">        this.userService = userService;</span>
<span class="fc" id="L64">    }</span>
    
    /**
     * Get current user profile
     * 
     * @return Detailed information of currently logged-in user
     */
    @GetMapping(&quot;/profile&quot;)
    @PreAuthorize(&quot;isAuthenticated()&quot;)
    public ResponseEntity&lt;ApiResponse&lt;UserDto&gt;&gt; getCurrentUserProfile() {
<span class="nc" id="L74">        Authentication authentication = SecurityContextHolder.getContext().getAuthentication();</span>
<span class="nc" id="L75">        String username = authentication.getName();</span>
        
<span class="nc" id="L77">        logger.debug(&quot;Get user profile: username={}&quot;, username);</span>
        
<span class="nc" id="L79">        UserDto userProfile = userService.getCurrentUserInfo(username);</span>
        
<span class="nc" id="L81">        return ResponseEntity.ok(ApiResponse.success(&quot;Get user profile successful&quot;, userProfile));</span>
    }
    
    /**
     * Update current user profile
     * 
     * @param updateRequest Update request data
     * @return Updated user information
     */
    @PutMapping(&quot;/profile&quot;)
    @PreAuthorize(&quot;isAuthenticated()&quot;)
    public ResponseEntity&lt;ApiResponse&lt;UserDto&gt;&gt; updateCurrentUserProfile(@Valid @RequestBody UpdateUserDto updateRequest) {
<span class="nc" id="L93">        Authentication authentication = SecurityContextHolder.getContext().getAuthentication();</span>
<span class="nc" id="L94">        String username = authentication.getName();</span>
        
<span class="nc" id="L96">        logger.info(&quot;Update user profile: username={}&quot;, username);</span>
        
        // Get current user information
<span class="nc" id="L99">        UserDto currentUser = userService.getCurrentUserInfo(username);</span>
        
        // Ensure regular users cannot modify admin fields
<span class="nc" id="L102">        UpdateUserDto userSafeRequest = updateRequest.forUserSelfUpdate();</span>
        
        // Update user information
<span class="nc" id="L105">        UserDto updatedUser = userService.updateUser(currentUser.getId(), userSafeRequest);</span>
        
<span class="nc" id="L107">        logger.info(&quot;User profile update successful: username={}&quot;, username);</span>
        
<span class="nc" id="L109">        return ResponseEntity.ok(ApiResponse.success(&quot;User profile update successful&quot;, updatedUser));</span>
    }
    
    /**
     * Get specified user information
     * 
     * @param userId User ID
     * @return User information
     */
    @GetMapping(&quot;/{userId}&quot;)
    @PreAuthorize(&quot;hasRole('ADMIN') or authentication.principal.id == #userId&quot;)
    public ResponseEntity&lt;ApiResponse&lt;UserDto&gt;&gt; getUserById(@PathVariable Long userId) {
<span class="nc" id="L121">        logger.debug(&quot;Get user information: userId={}&quot;, userId);</span>
        
<span class="nc" id="L123">        UserDto user = userService.getUserById(userId);</span>
        
<span class="nc" id="L125">        return ResponseEntity.ok(ApiResponse.success(&quot;Get user information successful&quot;, user));</span>
    }
    
    /**
     * Get user list (admin function)
     * 
     * @param role Optional role filter
     * @param pageable Pagination parameters
     * @return User list with pagination info
     */
    @GetMapping
    @PreAuthorize(&quot;hasRole('ADMIN')&quot;)
    public ResponseEntity&lt;ApiResponse&lt;Map&lt;String, Object&gt;&gt;&gt; getAllUsers(
            @RequestParam(required = false) UserRole role,
            @PageableDefault(size = 20, sort = &quot;createdAt&quot;, direction = Sort.Direction.DESC) Pageable pageable) {
        
<span class="nc" id="L141">        logger.debug(&quot;Get user list: role={}, page={}, size={}&quot;, role, pageable.getPageNumber(), pageable.getPageSize());</span>
        
        Page&lt;UserDto&gt; userPage;
<span class="nc bnc" id="L144" title="All 2 branches missed.">        if (role != null) {</span>
<span class="nc" id="L145">            userPage = userService.getUsersByRole(role, pageable);</span>
        } else {
<span class="nc" id="L147">            userPage = userService.getAllUsers(pageable);</span>
        }
        
<span class="nc" id="L150">        Map&lt;String, Object&gt; responseData = new HashMap&lt;&gt;();</span>
<span class="nc" id="L151">        responseData.put(&quot;users&quot;, userPage.getContent());</span>
<span class="nc" id="L152">        responseData.put(&quot;currentPage&quot;, userPage.getNumber());</span>
<span class="nc" id="L153">        responseData.put(&quot;totalPages&quot;, userPage.getTotalPages());</span>
<span class="nc" id="L154">        responseData.put(&quot;totalElements&quot;, userPage.getTotalElements());</span>
<span class="nc" id="L155">        responseData.put(&quot;size&quot;, userPage.getSize());</span>
<span class="nc" id="L156">        responseData.put(&quot;hasNext&quot;, userPage.hasNext());</span>
<span class="nc" id="L157">        responseData.put(&quot;hasPrevious&quot;, userPage.hasPrevious());</span>
        
<span class="nc" id="L159">        logger.debug(&quot;Get user list successful, total {} users on page {}/{}&quot;, </span>
<span class="nc" id="L160">                    userPage.getNumberOfElements(), userPage.getNumber() + 1, userPage.getTotalPages());</span>
        
<span class="nc" id="L162">        return ResponseEntity.ok(ApiResponse.success(&quot;Get user list successful&quot;, responseData));</span>
    }
    
    /**
     * Create new user (admin function)
     * 
     * @param createRequest Create user request
     * @return Created user information
     */
    @PostMapping
    @PreAuthorize(&quot;hasRole('ADMIN')&quot;)
    public ResponseEntity&lt;ApiResponse&lt;UserDto&gt;&gt; createUser(@Valid @RequestBody CreateUserDto createRequest) {
<span class="nc" id="L174">        logger.info(&quot;Admin creating new user: username={}&quot;, createRequest.getUsername());</span>
        
<span class="nc" id="L176">        UserDto createdUser = userService.createUser(createRequest);</span>
        
<span class="nc" id="L178">        logger.info(&quot;User created successfully: userId={}, username={}&quot;, createdUser.getId(), createdUser.getUsername());</span>
        
<span class="nc" id="L180">        return ResponseEntity.ok(ApiResponse.success(&quot;User created successfully&quot;, createdUser));</span>
    }
    
    /**
     * Update user information (admin function)
     * 
     * @param userId User ID
     * @param updateRequest Update request data
     * @return Updated user information
     */
    @PutMapping(&quot;/{userId}&quot;)
    @PreAuthorize(&quot;hasRole('ADMIN')&quot;)
    public ResponseEntity&lt;ApiResponse&lt;UserDto&gt;&gt; updateUser(@PathVariable Long userId,
                                        @Valid @RequestBody UpdateUserDto updateRequest) {
<span class="nc" id="L194">        logger.info(&quot;Admin updating user information: userId={}&quot;, userId);</span>

<span class="nc" id="L196">        UserDto updatedUser = userService.updateUser(userId, updateRequest);</span>

<span class="nc" id="L198">        logger.info(&quot;User information updated successfully: userId={}, username={}&quot;, userId, updatedUser.getUsername());</span>
        
<span class="nc" id="L200">        return ResponseEntity.ok(ApiResponse.success(&quot;User information updated successfully&quot;, updatedUser));</span>
    }

    /**
     * Disable user (admin function)
     *
     * @param userId User ID
     * @return Operation result
     */
    @DeleteMapping(&quot;/{userId}&quot;)
    @PreAuthorize(&quot;hasRole('ADMIN')&quot;)
    public ResponseEntity&lt;ApiResponse&lt;Void&gt;&gt; deleteUser(@PathVariable Long userId) {
<span class="nc" id="L212">        logger.info(&quot;Admin disabling user: userId={}&quot;, userId);</span>

<span class="nc" id="L214">        userService.deleteUser(userId);</span>

<span class="nc" id="L216">        logger.info(&quot;User disabled successfully: userId={}&quot;, userId);</span>
        
<span class="nc" id="L218">        return ResponseEntity.ok(ApiResponse.success(&quot;User has been disabled&quot;));</span>
    }

    /**
     * Enable user (admin function)
     *
     * @param userId User ID
     * @return Operation result
     */
    @PostMapping(&quot;/{userId}/enable&quot;)
    @PreAuthorize(&quot;hasRole('ADMIN')&quot;)
    public ResponseEntity&lt;ApiResponse&lt;Void&gt;&gt; enableUser(@PathVariable Long userId) {
<span class="nc" id="L230">        logger.info(&quot;Admin enabling user: userId={}&quot;, userId);</span>

<span class="nc" id="L232">        userService.enableUser(userId);</span>

<span class="nc" id="L234">        logger.info(&quot;User enabled successfully: userId={}&quot;, userId);</span>
        
<span class="nc" id="L236">        return ResponseEntity.ok(ApiResponse.success(&quot;User has been enabled&quot;));</span>
    }

    /**
     * Get user public profile
     *
     * @param userId User ID
     * @return Public user information
     */
    @GetMapping(&quot;/{userId}/public&quot;)
    public ResponseEntity&lt;ApiResponse&lt;UserDto&gt;&gt; getUserPublicProfile(@PathVariable Long userId) {
<span class="nc" id="L247">        logger.debug(&quot;Fetching user public profile: userId={}&quot;, userId);</span>

<span class="nc" id="L249">        UserDto publicProfile = userService.getUserPublicProfile(userId);</span>

<span class="nc" id="L251">        return ResponseEntity.ok(ApiResponse.success(&quot;Public profile fetched successfully&quot;, publicProfile));</span>
    }
}
</pre><div class="footer"><span class="right">Created with <a href="http://www.jacoco.org/jacoco">JaCoCo</a> 0.8.11.202310140853</span></div></body></html>