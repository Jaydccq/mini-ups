<?xml version="1.0" encoding="UTF-8"?><!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd"><html xmlns="http://www.w3.org/1999/xhtml" lang="en"><head><meta http-equiv="Content-Type" content="text/html;charset=UTF-8"/><link rel="stylesheet" href="../jacoco-resources/report.css" type="text/css"/><link rel="shortcut icon" href="../jacoco-resources/report.gif" type="image/gif"/><title>TruckManagementController.java</title><link rel="stylesheet" href="../jacoco-resources/prettify.css" type="text/css"/><script type="text/javascript" src="../jacoco-resources/prettify.js"></script></head><body onload="window['PR_TAB_WIDTH']=4;prettyPrint()"><div class="breadcrumb" id="breadcrumb"><span class="info"><a href="../jacoco-sessions.html" class="el_session">Sessions</a></span><a href="../index.html" class="el_report">Mini UPS Backend</a> &gt; <a href="index.source.html" class="el_package">com.miniups.controller</a> &gt; <span class="el_source">TruckManagementController.java</span></div><h1>TruckManagementController.java</h1><pre class="source lang-java linenums">/**
 * Truck Management Controller
 * 
 * Features:
 * - Provides REST API interfaces for truck fleet management
 * - Supports truck status queries, dispatch management, and statistical analysis
 * - Provides fleet monitoring functionality for operations personnel
 * 
 * API Endpoints:
 * - GET /api/trucks - Get all truck statuses
 * - GET /api/trucks/{truckId} - Get specified truck details
 * - PUT /api/trucks/{truckId}/status - Update truck status
 * - POST /api/trucks/{truckId}/assign - Manually assign truck
 * - POST /api/trucks/{truckId}/release - Release truck
 * - GET /api/trucks/statistics - Get fleet statistics
 * - GET /api/trucks/available - Get available truck list
 * 
 * Permission Control:
 * - Query operations: Operator and above permissions
 * - Management operations: Admin permissions
 * - Statistics viewing: Operator and above permissions
 * 
 * @author Mini-UPS Team
 * @version 1.0.0
 */
package com.miniups.controller;

import com.miniups.model.dto.common.ApiResponse;
import com.miniups.model.entity.Truck;
import com.miniups.service.TruckManagementService;

import org.slf4j.Logger;
import org.slf4j.LoggerFactory;
import org.springframework.beans.factory.annotation.Autowired;
import org.springframework.http.ResponseEntity;
import org.springframework.security.access.prepost.PreAuthorize;
import org.springframework.web.bind.annotation.*;

import java.util.HashMap;
import java.util.List;
import java.util.Map;

@RestController
@RequestMapping(&quot;/api/trucks&quot;)
@CrossOrigin(origins = &quot;*&quot;)
<span class="fc" id="L46">public class TruckManagementController {</span>
    
<span class="fc" id="L48">    private static final Logger logger = LoggerFactory.getLogger(TruckManagementController.class);</span>
    
    @Autowired
    private TruckManagementService truckManagementService;
    
    /**
     * Get status information for all trucks
     * 
     * @return Truck status list
     */
    @GetMapping
    @PreAuthorize(&quot;hasRole('ADMIN') or hasRole('OPERATOR')&quot;)
    public ResponseEntity&lt;ApiResponse&lt;Map&lt;String, Object&gt;&gt;&gt; getAllTrucks() {
<span class="nc" id="L61">        logger.info(&quot;Getting all truck statuses&quot;);</span>
        
<span class="nc" id="L63">        List&lt;Map&lt;String, Object&gt;&gt; truckStatuses = truckManagementService.getAllTruckStatuses();</span>
        
<span class="nc" id="L65">        Map&lt;String, Object&gt; responseData = Map.of(</span>
            &quot;trucks&quot;, truckStatuses,
<span class="nc" id="L67">            &quot;total_count&quot;, truckStatuses.size()</span>
        );
        
<span class="nc" id="L70">        return ResponseEntity.ok(ApiResponse.success(&quot;Truck statuses retrieved successfully&quot;, responseData));</span>
    }
    
    /**
     * Get fleet statistics
     * 
     * @return Statistical data
     */
    @GetMapping(&quot;/statistics&quot;)
    @PreAuthorize(&quot;hasRole('ADMIN') or hasRole('OPERATOR')&quot;)
    public ResponseEntity&lt;ApiResponse&lt;Map&lt;String, Object&gt;&gt;&gt; getFleetStatistics() {
<span class="nc" id="L81">        logger.info(&quot;Getting fleet statistics&quot;);</span>
        
<span class="nc" id="L83">        Map&lt;String, Object&gt; statistics = truckManagementService.getFleetStatistics();</span>
        
<span class="nc" id="L85">        return ResponseEntity.ok(ApiResponse.success(&quot;Fleet statistics retrieved successfully&quot;, statistics));</span>
    }
    
    /**
     * Update truck status and position
     * 
     * @param truckId Truck ID
     * @param statusUpdate Status update request
     * @return Update result
     */
    @PutMapping(&quot;/{truckId}/status&quot;)
    @PreAuthorize(&quot;hasRole('ADMIN') or hasRole('OPERATOR')&quot;)
    public ResponseEntity&lt;ApiResponse&lt;Map&lt;String, Object&gt;&gt;&gt; updateTruckStatus(
            @PathVariable Integer truckId,
            @RequestBody Map&lt;String, Object&gt; statusUpdate) {
<span class="nc" id="L100">        logger.info(&quot;Updating status for truck {}: {}&quot;, truckId, statusUpdate);</span>
        
<span class="nc" id="L102">        Integer x = extractIntegerValue(statusUpdate, &quot;x&quot;);</span>
<span class="nc" id="L103">        Integer y = extractIntegerValue(statusUpdate, &quot;y&quot;);</span>
<span class="nc" id="L104">        String status = (String) statusUpdate.get(&quot;status&quot;);</span>
        
<span class="nc bnc" id="L106" title="All 6 branches missed.">        if (x == null || y == null || status == null) {</span>
<span class="nc" id="L107">            return ResponseEntity.badRequest().body(</span>
<span class="nc" id="L108">                ApiResponse.error(&quot;Missing required fields: x, y, status&quot;)</span>
            );
        }
        
<span class="nc" id="L112">        boolean updated = truckManagementService.updateTruckStatus(truckId, x, y, status);</span>
        
<span class="nc bnc" id="L114" title="All 2 branches missed.">        if (updated) {</span>
<span class="nc" id="L115">            Map&lt;String, Object&gt; responseData = Map.of(</span>
                &quot;truck_id&quot;, truckId,
<span class="nc" id="L117">                &quot;new_position&quot;, Map.of(&quot;x&quot;, x, &quot;y&quot;, y),</span>
                &quot;new_status&quot;, status
            );
<span class="nc" id="L120">            return ResponseEntity.ok(ApiResponse.success(&quot;Truck status updated successfully&quot;, responseData));</span>
        } else {
<span class="nc" id="L122">            return ResponseEntity.badRequest().body(</span>
<span class="nc" id="L123">                ApiResponse.error(&quot;Failed to update truck status. Truck not found or invalid data.&quot;)</span>
            );
        }
    }
    
    /**
     * Manually assign truck to specified position
     * 
     * @param truckId Truck ID
     * @param assignmentRequest Assignment request
     * @return Assignment result
     */
    @PostMapping(&quot;/{truckId}/assign&quot;)
    @PreAuthorize(&quot;hasRole('ADMIN')&quot;)
    public ResponseEntity&lt;ApiResponse&lt;Map&lt;String, Object&gt;&gt;&gt; assignTruck(
            @PathVariable Integer truckId,
            @RequestBody Map&lt;String, Object&gt; assignmentRequest) {
<span class="nc" id="L140">        logger.info(&quot;Manual assignment for truck {}: {}&quot;, truckId, assignmentRequest);</span>
        
<span class="nc" id="L142">        Integer targetX = extractIntegerValue(assignmentRequest, &quot;target_x&quot;);</span>
<span class="nc" id="L143">        Integer targetY = extractIntegerValue(assignmentRequest, &quot;target_y&quot;);</span>
<span class="nc" id="L144">        Integer priority = extractIntegerValue(assignmentRequest, &quot;priority&quot;);</span>
        
<span class="nc bnc" id="L146" title="All 4 branches missed.">        if (targetX == null || targetY == null) {</span>
<span class="nc" id="L147">            return ResponseEntity.badRequest().body(</span>
<span class="nc" id="L148">                ApiResponse.error(&quot;Missing required fields: target_x, target_y&quot;)</span>
            );
        }
        
        // Use intelligent assignment algorithm
<span class="nc" id="L153">        Truck assignedTruck = truckManagementService.assignOptimalTruck(</span>
<span class="nc bnc" id="L154" title="All 2 branches missed.">            targetX, targetY, priority != null ? priority : 3</span>
        );
        
<span class="nc bnc" id="L157" title="All 2 branches missed.">        if (assignedTruck != null) {</span>
<span class="nc" id="L158">            Map&lt;String, Object&gt; responseData = Map.of(</span>
<span class="nc" id="L159">                &quot;assigned_truck&quot;, Map.of(</span>
<span class="nc" id="L160">                    &quot;truck_id&quot;, assignedTruck.getTruckId(),</span>
<span class="nc" id="L161">                    &quot;current_x&quot;, assignedTruck.getCurrentX(),</span>
<span class="nc" id="L162">                    &quot;current_y&quot;, assignedTruck.getCurrentY(),</span>
<span class="nc" id="L163">                    &quot;status&quot;, assignedTruck.getStatus().toString()</span>
                ),
<span class="nc" id="L165">                &quot;target_position&quot;, Map.of(&quot;x&quot;, targetX, &quot;y&quot;, targetY)</span>
            );
<span class="nc" id="L167">            return ResponseEntity.ok(ApiResponse.success(&quot;Truck assigned successfully&quot;, responseData));</span>
        } else {
<span class="nc" id="L169">            return ResponseEntity.status(503).body(</span>
<span class="nc" id="L170">                ApiResponse.error(&quot;No available trucks for assignment&quot;)</span>
            );
        }
    }
    
    /**
     * Release truck (set to idle status)
     * 
     * @param truckId Truck ID
     * @return Release result
     */
    @PostMapping(&quot;/{truckId}/release&quot;)
    @PreAuthorize(&quot;hasRole('ADMIN')&quot;)
    public ResponseEntity&lt;ApiResponse&lt;Map&lt;String, Object&gt;&gt;&gt; releaseTruck(@PathVariable Integer truckId) {
<span class="nc" id="L184">        logger.info(&quot;Releasing truck {}&quot;, truckId);</span>
        
<span class="nc" id="L186">        boolean released = truckManagementService.releaseTruck(truckId);</span>
        
<span class="nc bnc" id="L188" title="All 2 branches missed.">        if (released) {</span>
<span class="nc" id="L189">            Map&lt;String, Object&gt; responseData = Map.of(&quot;truck_id&quot;, truckId);</span>
<span class="nc" id="L190">            return ResponseEntity.ok(ApiResponse.success(&quot;Truck released successfully&quot;, responseData));</span>
        } else {
<span class="nc" id="L192">            return ResponseEntity.badRequest().body(</span>
<span class="nc" id="L193">                ApiResponse.error(&quot;Failed to release truck. Truck not found.&quot;)</span>
            );
        }
    }
    
    /**
     * Find nearest available truck
     * 
     * @param targetX Target X coordinate
     * @param targetY Target Y coordinate
     * @return Nearest available truck
     */
    @GetMapping(&quot;/nearest&quot;)
    @PreAuthorize(&quot;hasRole('ADMIN') or hasRole('OPERATOR')&quot;)
    public ResponseEntity&lt;ApiResponse&lt;Map&lt;String, Object&gt;&gt;&gt; findNearestTruck(
            @RequestParam Integer targetX,
            @RequestParam Integer targetY) {
<span class="nc" id="L210">        logger.info(&quot;Finding nearest truck to ({}, {})&quot;, targetX, targetY);</span>
        
<span class="nc" id="L212">        Truck nearestTruck = truckManagementService.findNearestAvailableTruck(targetX, targetY);</span>
        
<span class="nc bnc" id="L214" title="All 2 branches missed.">        if (nearestTruck != null) {</span>
<span class="nc" id="L215">            Map&lt;String, Object&gt; truckData = Map.of(</span>
<span class="nc" id="L216">                &quot;truck_id&quot;, nearestTruck.getTruckId(),</span>
<span class="nc" id="L217">                &quot;current_x&quot;, nearestTruck.getCurrentX(),</span>
<span class="nc" id="L218">                &quot;current_y&quot;, nearestTruck.getCurrentY(),</span>
<span class="nc" id="L219">                &quot;status&quot;, nearestTruck.getStatus().toString(),</span>
<span class="nc" id="L220">                &quot;capacity&quot;, nearestTruck.getCapacity()</span>
            );
            
            // Calculate distance
<span class="nc" id="L224">            double distance = Math.sqrt(</span>
<span class="nc" id="L225">                Math.pow(targetX - nearestTruck.getCurrentX(), 2) +</span>
<span class="nc" id="L226">                Math.pow(targetY - nearestTruck.getCurrentY(), 2)</span>
            );
            
<span class="nc" id="L229">            Map&lt;String, Object&gt; responseData = Map.of(</span>
                &quot;nearest_truck&quot;, truckData,
<span class="nc" id="L231">                &quot;distance&quot;, Math.round(distance * 100.0) / 100.0,</span>
<span class="nc" id="L232">                &quot;target_position&quot;, Map.of(&quot;x&quot;, targetX, &quot;y&quot;, targetY)</span>
            );
<span class="nc" id="L234">            return ResponseEntity.ok(ApiResponse.success(&quot;Nearest truck found successfully&quot;, responseData));</span>
        } else {
<span class="nc" id="L236">            return ResponseEntity.status(404).body(</span>
<span class="nc" id="L237">                ApiResponse.error(&quot;No available trucks found&quot;)</span>
            );
        }
    }
    
    /**
     * Batch update truck positions (for World Simulator callback use)
     * 
     * @param batchUpdate Batch update data
     * @return Update result
     */
    @PostMapping(&quot;/batch-update&quot;)
    @PreAuthorize(&quot;hasRole('ADMIN') or hasRole('SYSTEM')&quot;)
    public ResponseEntity&lt;ApiResponse&lt;Map&lt;String, Object&gt;&gt;&gt; batchUpdateTrucks(
            @RequestBody Map&lt;String, Object&gt; batchUpdate) {
        @SuppressWarnings(&quot;unchecked&quot;)
<span class="nc" id="L253">        List&lt;Map&lt;String, Object&gt;&gt; truckUpdates = (List&lt;Map&lt;String, Object&gt;&gt;) batchUpdate.get(&quot;truck_updates&quot;);</span>
        
<span class="nc bnc" id="L255" title="All 4 branches missed.">        if (truckUpdates == null || truckUpdates.isEmpty()) {</span>
<span class="nc" id="L256">            return ResponseEntity.badRequest().body(</span>
<span class="nc" id="L257">                ApiResponse.error(&quot;truck_updates list is required and cannot be empty&quot;)</span>
            );
        }
        
<span class="nc" id="L261">        truckManagementService.batchUpdateTruckPositions(truckUpdates);</span>
        
<span class="nc" id="L263">        Map&lt;String, Object&gt; responseData = Map.of(&quot;updated_count&quot;, truckUpdates.size());</span>
<span class="nc" id="L264">        return ResponseEntity.ok(ApiResponse.success(&quot;Batch update completed successfully&quot;, responseData));</span>
    }
    
    // Private helper methods
    
    private Integer extractIntegerValue(Map&lt;String, Object&gt; map, String key) {
<span class="nc" id="L270">        Object value = map.get(key);</span>
<span class="nc bnc" id="L271" title="All 2 branches missed.">        if (value instanceof Number) {</span>
<span class="nc" id="L272">            return ((Number) value).intValue();</span>
        }
<span class="nc" id="L274">        return null;</span>
    }
}
</pre><div class="footer"><span class="right">Created with <a href="http://www.jacoco.org/jacoco">JaCoCo</a> 0.8.11.202310140853</span></div></body></html>