<?xml version="1.0" encoding="UTF-8"?><!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd"><html xmlns="http://www.w3.org/1999/xhtml" lang="en"><head><meta http-equiv="Content-Type" content="text/html;charset=UTF-8"/><link rel="stylesheet" href="../jacoco-resources/report.css" type="text/css"/><link rel="shortcut icon" href="../jacoco-resources/report.gif" type="image/gif"/><title>AuthController.java</title><link rel="stylesheet" href="../jacoco-resources/prettify.css" type="text/css"/><script type="text/javascript" src="../jacoco-resources/prettify.js"></script></head><body onload="window['PR_TAB_WIDTH']=4;prettyPrint()"><div class="breadcrumb" id="breadcrumb"><span class="info"><a href="../jacoco-sessions.html" class="el_session">Sessions</a></span><a href="../index.html" class="el_report">Mini UPS Backend</a> &gt; <a href="index.source.html" class="el_package">com.miniups.controller</a> &gt; <span class="el_source">AuthController.java</span></div><h1>AuthController.java</h1><pre class="source lang-java linenums">/**
 * User Authentication Controller
 * 
 * Features:
 * - Handles user registration, login, password change and other authentication-related requests
 * - Provides JWT token issuance and validation functionality
 * - Supports user account status management
 * 
 * API Endpoints:
 * - POST /api/auth/register: User registration
 * - POST /api/auth/login: User login
 * - POST /api/auth/logout: User logout (optional)
 * - POST /api/auth/change-password: Change password
 * - GET /api/auth/me: Get current user information
 * - POST /api/auth/refresh: Refresh token (optional)
 * 
 * Security Features:
 * - Input validation and error handling
 * - Login failure attempt limiting
 * - JWT token security management
 * - CORS cross-origin support
 * 
 * @author Mini-UPS Team
 * @version 1.0.0
 */
package com.miniups.controller;

import com.miniups.model.dto.auth.AuthResponseDto;
import com.miniups.model.dto.auth.LoginRequestDto;
import com.miniups.model.dto.auth.PasswordChangeDto;
import com.miniups.model.dto.auth.RegisterRequestDto;
import com.miniups.model.dto.user.UserDto;
import com.miniups.model.dto.common.ApiResponse;
import com.miniups.service.AuthService;
import com.miniups.service.UserService;
import com.miniups.service.TokenBlacklistService;
import com.miniups.security.JwtTokenProvider;
import com.miniups.exception.BusinessValidationException;
import jakarta.validation.Valid;
import jakarta.servlet.http.HttpServletRequest;
import org.slf4j.Logger;
import org.slf4j.LoggerFactory;
import org.springframework.beans.factory.annotation.Autowired;
import org.springframework.http.HttpStatus;
import org.springframework.http.ResponseEntity;
import org.springframework.security.access.prepost.PreAuthorize;
import org.springframework.security.core.Authentication;
import org.springframework.security.core.context.SecurityContextHolder;
import org.springframework.util.StringUtils;
import org.springframework.web.bind.annotation.*;

import java.util.HashMap;
import java.util.Map;

@RestController
@RequestMapping(&quot;/api/auth&quot;)
public class AuthController {
    
<span class="fc" id="L59">    private static final Logger logger = LoggerFactory.getLogger(AuthController.class);</span>
    
    private final AuthService authService;
    private final UserService userService;
    private final TokenBlacklistService tokenBlacklistService;
    private final JwtTokenProvider jwtTokenProvider;
    
    public AuthController(AuthService authService, UserService userService, 
<span class="fc" id="L67">                         TokenBlacklistService tokenBlacklistService, JwtTokenProvider jwtTokenProvider) {</span>
<span class="fc" id="L68">        this.authService = authService;</span>
<span class="fc" id="L69">        this.userService = userService;</span>
<span class="fc" id="L70">        this.tokenBlacklistService = tokenBlacklistService;</span>
<span class="fc" id="L71">        this.jwtTokenProvider = jwtTokenProvider;</span>
<span class="fc" id="L72">    }</span>
    
    /**
     * User registration
     * 
     * @param registerRequest Registration request data
     * @return Registration success response and JWT token
     */
    @PostMapping(&quot;/register&quot;)
    public ResponseEntity&lt;ApiResponse&lt;AuthResponseDto&gt;&gt; registerUser(@Valid @RequestBody RegisterRequestDto registerRequest) {
<span class="nc" id="L82">        logger.info(&quot;User registration request: username={}, email={}&quot;, </span>
<span class="nc" id="L83">                   registerRequest.getUsername(), registerRequest.getEmail());</span>
        
<span class="nc" id="L85">        AuthResponseDto response = authService.register(registerRequest);</span>
        
<span class="nc" id="L87">        logger.info(&quot;User registration successful: username={}&quot;, registerRequest.getUsername());</span>
<span class="nc" id="L88">        return ResponseEntity.ok(ApiResponse.success(&quot;User registration successful&quot;, response));</span>
    }
    
    /**
     * User login
     * 
     * @param loginRequest Login request data
     * @return Login success response and JWT token
     */
    @PostMapping(&quot;/login&quot;)
    public ResponseEntity&lt;ApiResponse&lt;AuthResponseDto&gt;&gt; authenticateUser(@Valid @RequestBody LoginRequestDto loginRequest) {
<span class="nc" id="L99">        logger.info(&quot;User login request: usernameOrEmail={}&quot;, loginRequest.getUsernameOrEmail());</span>
        
<span class="nc" id="L101">        AuthResponseDto response = authService.login(loginRequest);</span>
        
<span class="nc" id="L103">        logger.info(&quot;User login successful: usernameOrEmail={}&quot;, loginRequest.getUsernameOrEmail());</span>
<span class="nc" id="L104">        return ResponseEntity.ok(ApiResponse.success(&quot;Login successful&quot;, response));</span>
    }
    
    /**
     * Get current user information
     * 
     * @return Detailed information of currently logged-in user
     */
    @GetMapping(&quot;/me&quot;)
    @PreAuthorize(&quot;isAuthenticated()&quot;)
    public ResponseEntity&lt;ApiResponse&lt;UserDto&gt;&gt; getCurrentUser() {
<span class="nc" id="L115">        Authentication authentication = SecurityContextHolder.getContext().getAuthentication();</span>
<span class="nc" id="L116">        String username = authentication.getName();</span>
        
<span class="nc" id="L118">        logger.debug(&quot;Get current user information request: username={}&quot;, username);</span>
        
<span class="nc" id="L120">        UserDto currentUser = userService.getCurrentUserInfo(username);</span>
        
<span class="nc" id="L122">        return ResponseEntity.ok(ApiResponse.success(&quot;Get user information successful&quot;, currentUser));</span>
    }
    
    /**
     * Change password
     * 
     * @param passwordChangeRequest Password change request data
     * @return Password change result
     */
    @PostMapping(&quot;/change-password&quot;)
    @PreAuthorize(&quot;isAuthenticated()&quot;)
    public ResponseEntity&lt;ApiResponse&lt;Void&gt;&gt; changePassword(@Valid @RequestBody PasswordChangeDto passwordChangeRequest) {
<span class="nc" id="L134">        Authentication authentication = SecurityContextHolder.getContext().getAuthentication();</span>
<span class="nc" id="L135">        String username = authentication.getName();</span>
        
<span class="nc" id="L137">        logger.info(&quot;User change password request: username={}&quot;, username);</span>
        
        // Validate new password confirmation
<span class="nc bnc" id="L140" title="All 2 branches missed.">        if (!passwordChangeRequest.isPasswordsMatch()) {</span>
<span class="nc" id="L141">            throw new BusinessValidationException(&quot;PASSWORD_MISMATCH&quot;, &quot;New password does not match confirmation password&quot;);</span>
        }
        
<span class="nc" id="L144">        authService.changePassword(username, passwordChangeRequest);</span>
        
<span class="nc" id="L146">        logger.info(&quot;User password change successful: username={}&quot;, username);</span>
        
<span class="nc" id="L148">        return ResponseEntity.ok(ApiResponse.success(&quot;Password change successful&quot;));</span>
    }
    
    /**
     * User logout
     * 
     * @param request HTTP request to extract JWT token
     * @return Logout success response
     */
    @PostMapping(&quot;/logout&quot;)
    @PreAuthorize(&quot;isAuthenticated()&quot;)
    public ResponseEntity&lt;ApiResponse&lt;Void&gt;&gt; logoutUser(HttpServletRequest request) {
<span class="nc" id="L160">        Authentication authentication = SecurityContextHolder.getContext().getAuthentication();</span>
<span class="nc" id="L161">        String username = authentication.getName();</span>
        
<span class="nc" id="L163">        logger.info(&quot;User logout request: username={}&quot;, username);</span>
        
        try {
            // Extract JWT token from request
<span class="nc" id="L167">            String jwt = getJwtFromRequest(request);</span>
            
<span class="nc bnc" id="L169" title="All 2 branches missed.">            if (StringUtils.hasText(jwt)) {</span>
                // Get token ID and remaining time
<span class="nc" id="L171">                String tokenId = jwtTokenProvider.getTokenIdFromToken(jwt);</span>
<span class="nc" id="L172">                long remainingTime = jwtTokenProvider.getRemainingTimeInSeconds(jwt);</span>
                
<span class="nc bnc" id="L174" title="All 4 branches missed.">                if (tokenId != null &amp;&amp; remainingTime &gt; 0) {</span>
                    // Add token to blacklist
<span class="nc" id="L176">                    tokenBlacklistService.blacklistToken(tokenId, remainingTime);</span>
<span class="nc" id="L177">                    logger.info(&quot;Token blacklisted successfully: tokenId={}, remainingTime={}s&quot;, tokenId, remainingTime);</span>
                }
            }
<span class="nc" id="L180">        } catch (Exception e) {</span>
<span class="nc" id="L181">            logger.error(&quot;Error during token blacklisting: username={}&quot;, username, e);</span>
            // Don't fail the logout process if blacklisting fails
<span class="nc" id="L183">        }</span>
        
        // Clear security context
<span class="nc" id="L186">        SecurityContextHolder.clearContext();</span>
        
<span class="nc" id="L188">        logger.info(&quot;User logout successful: username={}&quot;, username);</span>
<span class="nc" id="L189">        return ResponseEntity.ok(ApiResponse.success(&quot;Logout successful&quot;));</span>
    }
    
    /**
     * Extract JWT token from request Authorization header
     * 
     * @param request HTTP request
     * @return JWT token string or null
     */
    private String getJwtFromRequest(HttpServletRequest request) {
<span class="nc" id="L199">        String bearerToken = request.getHeader(&quot;Authorization&quot;);</span>
<span class="nc bnc" id="L200" title="All 4 branches missed.">        if (StringUtils.hasText(bearerToken) &amp;&amp; bearerToken.startsWith(&quot;Bearer &quot;)) {</span>
<span class="nc" id="L201">            return bearerToken.substring(7);</span>
        }
<span class="nc" id="L203">        return null;</span>
    }
    
    /**
     * Validate token validity
     * 
     * @return Token validation result
     */
    @GetMapping(&quot;/validate&quot;)
    @PreAuthorize(&quot;isAuthenticated()&quot;)
    public ResponseEntity&lt;ApiResponse&lt;Map&lt;String, Object&gt;&gt;&gt; validateToken() {
<span class="nc" id="L214">        Authentication authentication = SecurityContextHolder.getContext().getAuthentication();</span>
<span class="nc" id="L215">        String username = authentication.getName();</span>
        
<span class="nc" id="L217">        Map&lt;String, Object&gt; data = new HashMap&lt;&gt;();</span>
<span class="nc" id="L218">        data.put(&quot;username&quot;, username);</span>
<span class="nc" id="L219">        data.put(&quot;authenticated&quot;, true);</span>
        
<span class="nc" id="L221">        return ResponseEntity.ok(ApiResponse.success(&quot;Token valid&quot;, data));</span>
    }
    
    /**
     * Check if username is available
     * 
     * @param username Username to check
     * @return Availability check result
     */
    @GetMapping(&quot;/check-username&quot;)
    public ResponseEntity&lt;ApiResponse&lt;Map&lt;String, Object&gt;&gt;&gt; checkUsernameAvailability(@RequestParam String username) {
<span class="nc" id="L232">        boolean available = userService.isUsernameAvailable(username);</span>
        
<span class="nc" id="L234">        Map&lt;String, Object&gt; data = new HashMap&lt;&gt;();</span>
<span class="nc" id="L235">        data.put(&quot;available&quot;, available);</span>
        
<span class="nc bnc" id="L237" title="All 2 branches missed.">        String message = available ? &quot;Username available&quot; : &quot;Username already taken&quot;;</span>
<span class="nc" id="L238">        return ResponseEntity.ok(ApiResponse.success(message, data));</span>
    }
    
    /**
     * Check if email is available
     * 
     * @param email Email to check
     * @return Availability check result
     */
    @GetMapping(&quot;/check-email&quot;)
    public ResponseEntity&lt;ApiResponse&lt;Map&lt;String, Object&gt;&gt;&gt; checkEmailAvailability(@RequestParam String email) {
<span class="nc" id="L249">        boolean available = userService.isEmailAvailable(email);</span>
        
<span class="nc" id="L251">        Map&lt;String, Object&gt; data = new HashMap&lt;&gt;();</span>
<span class="nc" id="L252">        data.put(&quot;available&quot;, available);</span>
        
<span class="nc bnc" id="L254" title="All 2 branches missed.">        String message = available ? &quot;Email available&quot; : &quot;Email already taken&quot;;</span>
<span class="nc" id="L255">        return ResponseEntity.ok(ApiResponse.success(message, data));</span>
    }
    
}
</pre><div class="footer"><span class="right">Created with <a href="http://www.jacoco.org/jacoco">JaCoCo</a> 0.8.11.202310140853</span></div></body></html>