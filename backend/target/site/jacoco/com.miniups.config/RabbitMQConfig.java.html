<?xml version="1.0" encoding="UTF-8"?><!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd"><html xmlns="http://www.w3.org/1999/xhtml" lang="en"><head><meta http-equiv="Content-Type" content="text/html;charset=UTF-8"/><link rel="stylesheet" href="../jacoco-resources/report.css" type="text/css"/><link rel="shortcut icon" href="../jacoco-resources/report.gif" type="image/gif"/><title>RabbitMQConfig.java</title><link rel="stylesheet" href="../jacoco-resources/prettify.css" type="text/css"/><script type="text/javascript" src="../jacoco-resources/prettify.js"></script></head><body onload="window['PR_TAB_WIDTH']=4;prettyPrint()"><div class="breadcrumb" id="breadcrumb"><span class="info"><a href="../jacoco-sessions.html" class="el_session">Sessions</a></span><a href="../index.html" class="el_report">Mini UPS Backend</a> &gt; <a href="index.source.html" class="el_package">com.miniups.config</a> &gt; <span class="el_source">RabbitMQConfig.java</span></div><h1>RabbitMQConfig.java</h1><pre class="source lang-java linenums">package com.miniups.config;

import com.fasterxml.jackson.databind.ObjectMapper;
import org.springframework.amqp.core.*;
import org.springframework.amqp.rabbit.config.SimpleRabbitListenerContainerFactory;
import org.springframework.amqp.rabbit.connection.ConnectionFactory;
import org.springframework.amqp.rabbit.core.RabbitTemplate;
import org.springframework.amqp.support.converter.Jackson2JsonMessageConverter;
import org.springframework.amqp.support.converter.MessageConverter;
import org.springframework.context.annotation.Bean;
import org.springframework.context.annotation.Configuration;
import org.springframework.boot.autoconfigure.amqp.SimpleRabbitListenerContainerFactoryConfigurer;

/**
 * RabbitMQ Configuration
 * 
 * Configures the RabbitMQ topology, message converters, and connection settings
 * for the Mini-UPS messaging infrastructure. This configuration implements
 * an event-driven architecture with reliable message processing.
 * 
 * Topology Design:
 * - Topic Exchange: ups.events.topic (main routing hub)
 * - Dead Letter Exchange: ups.events.dlx (reliability mechanism)
 * - Specialized queues for different business domains
 * 
 * @author Mini-UPS Development Team
 * @version 1.0
 * @since 2024
 */
@Configuration
<span class="nc" id="L31">public class RabbitMQConfig {</span>

    // Exchange Names
    public static final String TOPIC_EXCHANGE_NAME = &quot;ups.events.topic&quot;;
    public static final String DLX_NAME = &quot;ups.events.dlx&quot;;

    // Queue Names
    public static final String SHIPMENT_PROCESSOR_QUEUE = &quot;q.shipment.processor&quot;;
    public static final String NOTIFICATIONS_QUEUE = &quot;q.notifications&quot;;
    public static final String AUDIT_LOG_QUEUE = &quot;q.audit_log&quot;;
    public static final String WORLD_SIMULATOR_QUEUE = &quot;q.world_simulator&quot;;
    public static final String DEAD_LETTER_QUEUE = &quot;q.dead_letter&quot;;

    // Routing Keys
    public static final String SHIPMENT_CREATE_ROUTING_KEY = &quot;shipment.create.request&quot;;
    public static final String SHIPMENT_STATUS_ROUTING_KEY = &quot;shipment.status.updated&quot;;
    public static final String USER_REGISTERED_ROUTING_KEY = &quot;user.registered&quot;;
    public static final String TRUCK_DISPATCH_ROUTING_KEY = &quot;truck.dispatch&quot;;
    public static final String AUDIT_LOG_ROUTING_KEY = &quot;audit.log.created&quot;;

    /**
     * Main topic exchange for all business events
     * Uses topic routing for flexible message routing based on routing keys
     */
    @Bean
    public TopicExchange topicExchange() {
<span class="nc" id="L57">        return ExchangeBuilder.topicExchange(TOPIC_EXCHANGE_NAME)</span>
<span class="nc" id="L58">                .durable(true)</span>
<span class="nc" id="L59">                .build();</span>
    }

    /**
     * Dead letter exchange for failed messages
     * Provides reliability by capturing messages that cannot be processed
     */
    @Bean
    public FanoutExchange deadLetterExchange() {
<span class="nc" id="L68">        return ExchangeBuilder.fanoutExchange(DLX_NAME)</span>
<span class="nc" id="L69">                .durable(true)</span>
<span class="nc" id="L70">                .build();</span>
    }

    /**
     * Queue for processing shipment creation requests
     * High-priority queue with dead letter routing for reliability
     */
    @Bean
    public Queue shipmentProcessorQueue() {
<span class="nc" id="L79">        return QueueBuilder.durable(SHIPMENT_PROCESSOR_QUEUE)</span>
<span class="nc" id="L80">                .withArgument(&quot;x-dead-letter-exchange&quot;, DLX_NAME)</span>
<span class="nc" id="L81">                .withArgument(&quot;x-dead-letter-routing-key&quot;, &quot;failed.shipment.processor&quot;)</span>
<span class="nc" id="L82">                .build();</span>
    }

    /**
     * Queue for notification processing
     * Handles user notifications across multiple channels
     */
    @Bean
    public Queue notificationsQueue() {
<span class="nc" id="L91">        return QueueBuilder.durable(NOTIFICATIONS_QUEUE)</span>
<span class="nc" id="L92">                .withArgument(&quot;x-dead-letter-exchange&quot;, DLX_NAME)</span>
<span class="nc" id="L93">                .withArgument(&quot;x-dead-letter-routing-key&quot;, &quot;failed.notifications&quot;)</span>
<span class="nc" id="L94">                .build();</span>
    }

    /**
     * Queue for audit log processing
     * Captures all system events for compliance and monitoring
     */
    @Bean
    public Queue auditLogQueue() {
<span class="nc" id="L103">        return QueueBuilder.durable(AUDIT_LOG_QUEUE)</span>
<span class="nc" id="L104">                .withArgument(&quot;x-dead-letter-exchange&quot;, DLX_NAME)</span>
<span class="nc" id="L105">                .withArgument(&quot;x-dead-letter-routing-key&quot;, &quot;failed.audit_log&quot;)</span>
<span class="nc" id="L106">                .build();</span>
    }

    /**
     * Queue for world simulator integration
     * Handles communication with external world simulation system
     */
    @Bean
    public Queue worldSimulatorQueue() {
<span class="nc" id="L115">        return QueueBuilder.durable(WORLD_SIMULATOR_QUEUE)</span>
<span class="nc" id="L116">                .withArgument(&quot;x-dead-letter-exchange&quot;, DLX_NAME)</span>
<span class="nc" id="L117">                .withArgument(&quot;x-dead-letter-routing-key&quot;, &quot;failed.world_simulator&quot;)</span>
<span class="nc" id="L118">                .build();</span>
    }

    /**
     * Dead letter queue for failed message handling
     * Stores messages that cannot be processed for manual intervention
     */
    @Bean
    public Queue deadLetterQueue() {
<span class="nc" id="L127">        return QueueBuilder.durable(DEAD_LETTER_QUEUE).build();</span>
    }

    // Bindings: Connect queues to exchanges with routing patterns

    @Bean
    public Binding shipmentProcessorBinding() {
<span class="nc" id="L134">        return BindingBuilder.bind(shipmentProcessorQueue())</span>
<span class="nc" id="L135">                .to(topicExchange())</span>
<span class="nc" id="L136">                .with(&quot;shipment.create.*&quot;);</span>
    }

    @Bean
    public Binding notificationsShipmentBinding() {
<span class="nc" id="L141">        return BindingBuilder.bind(notificationsQueue())</span>
<span class="nc" id="L142">                .to(topicExchange())</span>
<span class="nc" id="L143">                .with(&quot;shipment.#&quot;);</span>
    }

    @Bean
    public Binding notificationsUserBinding() {
<span class="nc" id="L148">        return BindingBuilder.bind(notificationsQueue())</span>
<span class="nc" id="L149">                .to(topicExchange())</span>
<span class="nc" id="L150">                .with(&quot;user.#&quot;);</span>
    }

    @Bean
    public Binding auditLogCreatedBinding() {
<span class="nc" id="L155">        return BindingBuilder.bind(auditLogQueue())</span>
<span class="nc" id="L156">                .to(topicExchange())</span>
<span class="nc" id="L157">                .with(&quot;*.*.created&quot;);</span>
    }

    @Bean
    public Binding auditLogUpdatedBinding() {
<span class="nc" id="L162">        return BindingBuilder.bind(auditLogQueue())</span>
<span class="nc" id="L163">                .to(topicExchange())</span>
<span class="nc" id="L164">                .with(&quot;*.*.updated&quot;);</span>
    }

    @Bean
    public Binding worldSimulatorBinding() {
<span class="nc" id="L169">        return BindingBuilder.bind(worldSimulatorQueue())</span>
<span class="nc" id="L170">                .to(topicExchange())</span>
<span class="nc" id="L171">                .with(TRUCK_DISPATCH_ROUTING_KEY);</span>
    }

    @Bean
    public Binding deadLetterBinding() {
<span class="nc" id="L176">        return BindingBuilder.bind(deadLetterQueue())</span>
<span class="nc" id="L177">                .to(deadLetterExchange());</span>
    }

    /**
     * JSON message converter for object serialization
     * Uses Jackson for consistent JSON handling across the application
     */
    @Bean
    public MessageConverter jsonMessageConverter(ObjectMapper objectMapper) {
<span class="nc" id="L186">        Jackson2JsonMessageConverter converter = new Jackson2JsonMessageConverter(objectMapper);</span>
<span class="nc" id="L187">        converter.setCreateMessageIds(true);</span>
<span class="nc" id="L188">        return converter;</span>
    }

    /**
     * RabbitTemplate for sending messages
     * Configured with JSON converter and reliability features
     */
    @Bean
    public RabbitTemplate rabbitTemplate(ConnectionFactory connectionFactory, 
                                       MessageConverter messageConverter) {
<span class="nc" id="L198">        RabbitTemplate template = new RabbitTemplate(connectionFactory);</span>
<span class="nc" id="L199">        template.setMessageConverter(messageConverter);</span>
<span class="nc" id="L200">        template.setExchange(TOPIC_EXCHANGE_NAME);</span>
<span class="nc" id="L201">        template.setConfirmCallback((correlationData, ack, cause) -&gt; {</span>
<span class="nc bnc" id="L202" title="All 2 branches missed.">            if (!ack) {</span>
                // Log failed message publication
<span class="nc" id="L204">                System.err.println(&quot;Message failed to reach exchange: &quot; + cause);</span>
            }
<span class="nc" id="L206">        });</span>
<span class="nc" id="L207">        template.setReturnsCallback(returnedMessage -&gt; {</span>
            // Log returned messages (no matching queue)
<span class="nc" id="L209">            System.err.println(&quot;Message returned: &quot; + returnedMessage);</span>
<span class="nc" id="L210">        });</span>
<span class="nc" id="L211">        return template;</span>
    }

    /**
     * Container factory for message listeners
     * Configures manual acknowledgment and retry policies
     */
    @Bean
    public SimpleRabbitListenerContainerFactory rabbitListenerContainerFactory(
            ConnectionFactory connectionFactory,
            SimpleRabbitListenerContainerFactoryConfigurer configurer,
            MessageConverter messageConverter) {
        
<span class="nc" id="L224">        SimpleRabbitListenerContainerFactory factory = new SimpleRabbitListenerContainerFactory();</span>
<span class="nc" id="L225">        configurer.configure(factory, connectionFactory);</span>
<span class="nc" id="L226">        factory.setMessageConverter(messageConverter);</span>
        
        // Configure error handling
<span class="nc" id="L229">        factory.setErrorHandler(throwable -&gt; {</span>
<span class="nc" id="L230">            System.err.println(&quot;Error in message processing: &quot; + throwable.getMessage());</span>
<span class="nc" id="L231">            throwable.printStackTrace();</span>
<span class="nc" id="L232">        });</span>
        
<span class="nc" id="L234">        return factory;</span>
    }
}
</pre><div class="footer"><span class="right">Created with <a href="http://www.jacoco.org/jacoco">JaCoCo</a> 0.8.11.202310140853</span></div></body></html>