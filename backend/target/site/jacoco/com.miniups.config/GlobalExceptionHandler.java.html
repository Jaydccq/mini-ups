<?xml version="1.0" encoding="UTF-8"?><!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd"><html xmlns="http://www.w3.org/1999/xhtml" lang="en"><head><meta http-equiv="Content-Type" content="text/html;charset=UTF-8"/><link rel="stylesheet" href="../jacoco-resources/report.css" type="text/css"/><link rel="shortcut icon" href="../jacoco-resources/report.gif" type="image/gif"/><title>GlobalExceptionHandler.java</title><link rel="stylesheet" href="../jacoco-resources/prettify.css" type="text/css"/><script type="text/javascript" src="../jacoco-resources/prettify.js"></script></head><body onload="window['PR_TAB_WIDTH']=4;prettyPrint()"><div class="breadcrumb" id="breadcrumb"><span class="info"><a href="../jacoco-sessions.html" class="el_session">Sessions</a></span><a href="../index.html" class="el_report">Mini UPS Backend</a> &gt; <a href="index.source.html" class="el_package">com.miniups.config</a> &gt; <span class="el_source">GlobalExceptionHandler.java</span></div><h1>GlobalExceptionHandler.java</h1><pre class="source lang-java linenums">/**
 * Global Exception Handler
 *
 * Functionality:
 * - Unified handling of all exceptions in the application
 * - Provides standardized error response format
 * - Prevents sensitive information leakage
 *
 * Exception Types Handled:
 * - Authentication Exceptions: login failures, invalid tokens, etc.
 * - Authorization Exceptions: insufficient permissions, role mismatches, etc.
 * - Validation Exceptions: input format errors, missing required fields, etc.
 * - Business Exceptions: user not found, duplicate email, etc.
 * - System Exceptions: database errors, network issues, etc.
 *
 * Security Features:
 * - Does not expose internal system information
 * - Records detailed error logs for debugging
 * - Returns user-friendly error messages
 *
 * @author Mini-UPS Team
 * @version 1.0.0
 */
package com.miniups.config;

import com.miniups.exception.*;
import com.miniups.model.dto.common.ApiResponse;
import org.slf4j.Logger;
import org.slf4j.LoggerFactory;
import org.springframework.http.HttpStatus;
import org.springframework.http.ResponseEntity;
import org.springframework.security.access.AccessDeniedException;
import org.springframework.security.authentication.BadCredentialsException;
import org.springframework.security.core.AuthenticationException;
import org.springframework.validation.FieldError;
import org.springframework.web.bind.MethodArgumentNotValidException;
import org.springframework.web.bind.annotation.ControllerAdvice;
import org.springframework.web.bind.annotation.ExceptionHandler;
import org.springframework.web.context.request.WebRequest;
import org.springframework.dao.DataAccessException;
import org.springframework.dao.DataIntegrityViolationException;
import org.springframework.web.HttpRequestMethodNotSupportedException;
import org.springframework.web.bind.MissingServletRequestParameterException;
import org.springframework.beans.factory.annotation.Value;
import org.springframework.core.Ordered;
import org.springframework.core.annotation.Order;

import java.time.LocalDateTime;
import java.util.HashMap;
import java.util.Map;

@ControllerAdvice
@Order(Ordered.HIGHEST_PRECEDENCE)
public class GlobalExceptionHandler {

<span class="nc" id="L56">    private static final Logger logger = LoggerFactory.getLogger(GlobalExceptionHandler.class);</span>
    
    @Value(&quot;${app.environment:production}&quot;)
    private String environment;
    
    @Value(&quot;${app.exception.include-stack-trace:false}&quot;)
    private boolean includeStackTrace;
    
    private final ExceptionMetricsConfig exceptionMetrics;
    
<span class="nc" id="L66">    public GlobalExceptionHandler(ExceptionMetricsConfig exceptionMetrics) {</span>
<span class="nc" id="L67">        this.exceptionMetrics = exceptionMetrics;</span>
<span class="nc" id="L68">    }</span>

    /**
     * 统一构建错误响应的方法
     * 
     * @param ex 异常对象
     * @param errorCode 错误代码
     * @param defaultMessage 默认错误消息
     * @param status HTTP状态码
     * @param data 可选的附加数据
     * @return 标准化的错误响应
     */
    private &lt;T&gt; ResponseEntity&lt;ApiResponse&lt;T&gt;&gt; buildErrorResponse(
            Exception ex, String errorCode, String defaultMessage, HttpStatus status, T data) {
        
<span class="nc" id="L83">        recordExceptionMetrics(ex);</span>
        
<span class="nc" id="L85">        String message = defaultMessage;</span>
<span class="nc bnc" id="L86" title="All 2 branches missed.">        if (ex instanceof BaseBusinessException) {</span>
<span class="nc" id="L87">            message = ex.getMessage();</span>
<span class="nc bnc" id="L88" title="All 2 branches missed.">        } else if (&quot;development&quot;.equals(environment)) {</span>
<span class="nc bnc" id="L89" title="All 2 branches missed.">            message = ex.getMessage() != null ? ex.getMessage() : defaultMessage;</span>
        }
        
<span class="nc bnc" id="L92" title="All 2 branches missed.">        if (status.is5xxServerError()) {</span>
<span class="nc" id="L93">            logger.error(&quot;Exception handled: code={}, message={}, type={}&quot;, </span>
<span class="nc" id="L94">                        errorCode, message, ex.getClass().getSimpleName(), ex);</span>
<span class="nc bnc" id="L95" title="All 2 branches missed.">        } else if (status.is4xxClientError()) {</span>
<span class="nc" id="L96">            logger.warn(&quot;Client error handled: code={}, message={}, type={}&quot;, </span>
<span class="nc" id="L97">                       errorCode, message, ex.getClass().getSimpleName());</span>
        } else {
<span class="nc" id="L99">            logger.info(&quot;Exception handled: code={}, message={}, type={}&quot;, </span>
<span class="nc" id="L100">                       errorCode, message, ex.getClass().getSimpleName());</span>
        }
        
<span class="nc" id="L103">        ApiResponse&lt;T&gt; response = ApiResponse.error(errorCode, message);</span>
<span class="nc bnc" id="L104" title="All 2 branches missed.">        if (data != null) {</span>
<span class="nc" id="L105">            response.setData(data);</span>
        }
        
<span class="nc" id="L108">        return new ResponseEntity&lt;&gt;(response, status);</span>
    }
    

    private void recordExceptionMetrics(Exception exception) {
<span class="nc bnc" id="L113" title="All 2 branches missed.">        if (exceptionMetrics != null) {</span>
<span class="nc" id="L114">            String endpoint = ExceptionMetricsConfig.getCurrentEndpoint();</span>
<span class="nc" id="L115">            exceptionMetrics.recordException(exception, endpoint);</span>
        }
<span class="nc" id="L117">    }</span>

    /**
     * Handle user already exists exception
     */
    @ExceptionHandler(UserAlreadyExistsException.class)
    public ResponseEntity&lt;ApiResponse&lt;Void&gt;&gt; handleUserAlreadyExistsException(
            UserAlreadyExistsException ex, WebRequest request) {
<span class="nc" id="L125">        return buildErrorResponse(ex, &quot;USER_ALREADY_EXISTS&quot;, ex.getMessage(), HttpStatus.BAD_REQUEST, null);</span>
    }

    /**
     * Handle user not found exception
     */
    @ExceptionHandler(UserNotFoundException.class)
    public ResponseEntity&lt;ApiResponse&lt;Void&gt;&gt; handleUserNotFoundException(
            UserNotFoundException ex, WebRequest request) {
<span class="nc" id="L134">        return buildErrorResponse(ex, &quot;USER_NOT_FOUND&quot;, ex.getMessage(), HttpStatus.NOT_FOUND, null);</span>
    }

    /**
     * Handle invalid credentials exception
     */
    @ExceptionHandler(InvalidCredentialsException.class)
    public ResponseEntity&lt;ApiResponse&lt;Void&gt;&gt; handleInvalidCredentialsException(
            InvalidCredentialsException ex, WebRequest request) {
<span class="nc" id="L143">        return buildErrorResponse(ex, &quot;INVALID_CREDENTIALS&quot;, ex.getMessage(), HttpStatus.UNAUTHORIZED, null);</span>
    }

    /**
     * Handle input validation exception
     */
    @ExceptionHandler(MethodArgumentNotValidException.class)
    public ResponseEntity&lt;ApiResponse&lt;Map&lt;String, String&gt;&gt;&gt; handleValidationExceptions(
            MethodArgumentNotValidException ex, WebRequest request) {

<span class="nc" id="L153">        Map&lt;String, String&gt; fieldErrors = new HashMap&lt;&gt;();</span>
<span class="nc" id="L154">        ex.getBindingResult().getAllErrors().forEach((error) -&gt; {</span>
<span class="nc" id="L155">            String fieldName = ((FieldError) error).getField();</span>
<span class="nc" id="L156">            String errorMessage = error.getDefaultMessage();</span>
<span class="nc" id="L157">            fieldErrors.put(fieldName, errorMessage);</span>
<span class="nc" id="L158">        });</span>

<span class="nc" id="L160">        return buildErrorResponse(ex, &quot;VALIDATION_ERROR&quot;, &quot;Please check input data format&quot;, HttpStatus.BAD_REQUEST, fieldErrors);</span>
    }

    /**
     * Handle authentication exception
     */
    @ExceptionHandler(AuthenticationException.class)
    public ResponseEntity&lt;ApiResponse&lt;Void&gt;&gt; handleAuthenticationException(
            AuthenticationException ex, WebRequest request) {
<span class="nc" id="L169">        return buildErrorResponse(ex, &quot;AUTHENTICATION_ERROR&quot;, &quot;Invalid username or password&quot;, HttpStatus.UNAUTHORIZED, null);</span>
    }

    /**
     * Handle bad credentials exception
     */
    @ExceptionHandler(BadCredentialsException.class)
    public ResponseEntity&lt;ApiResponse&lt;Void&gt;&gt; handleBadCredentialsException(
            BadCredentialsException ex, WebRequest request) {
<span class="nc" id="L178">        return buildErrorResponse(ex, &quot;BAD_CREDENTIALS&quot;, &quot;Invalid username or password&quot;, HttpStatus.UNAUTHORIZED, null);</span>
    }

    /**
     * Handle access denied exception
     */
    @ExceptionHandler(AccessDeniedException.class)
    public ResponseEntity&lt;ApiResponse&lt;Void&gt;&gt; handleAccessDeniedException(
            AccessDeniedException ex, WebRequest request) {
<span class="nc" id="L187">        return buildErrorResponse(ex, &quot;ACCESS_DENIED&quot;, &quot;You do not have permission to perform this operation&quot;, HttpStatus.FORBIDDEN, null);</span>
    }

    /*
     * RuntimeException handling removed - these exceptions should be handled by
     * the global Exception handler with 500 status code to properly indicate
     * server-side errors rather than client errors (400).
     * 
     * If specific RuntimeException subclasses need custom handling, 
     * add explicit handlers for those specific types instead.
     */

    /**
     * Handle illegal argument exception
     */
    @ExceptionHandler(IllegalArgumentException.class)
    public ResponseEntity&lt;ApiResponse&lt;Void&gt;&gt; handleIllegalArgumentException(
            IllegalArgumentException ex, WebRequest request) {
<span class="nc bnc" id="L205" title="All 2 branches missed.">        String message = ex.getMessage() != null ? ex.getMessage() : &quot;Invalid request parameters&quot;;</span>
<span class="nc" id="L206">        return buildErrorResponse(ex, &quot;INVALID_PARAMETER&quot;, message, HttpStatus.BAD_REQUEST, null);</span>
    }

    /**
     * Handle null pointer exception
     */
    @ExceptionHandler(NullPointerException.class)
    public ResponseEntity&lt;ApiResponse&lt;Void&gt;&gt; handleNullPointerException(
            NullPointerException ex, WebRequest request) {
<span class="nc" id="L215">        return buildErrorResponse(ex, &quot;SYSTEM_ERROR&quot;, &quot;Internal server error, please try again later&quot;, HttpStatus.INTERNAL_SERVER_ERROR, null);</span>
    }

    /**
     * Handle external service exceptions
     */
    @ExceptionHandler(ExternalServiceException.class)
    public ResponseEntity&lt;ApiResponse&lt;Void&gt;&gt; handleExternalServiceException(
            ExternalServiceException ex, WebRequest request) {
<span class="nc bnc" id="L224" title="All 2 branches missed.">        String userMessage = &quot;development&quot;.equals(environment) </span>
<span class="nc" id="L225">            ? ex.getMessage() </span>
<span class="nc" id="L226">            : &quot;External service is temporarily unavailable, please try again later&quot;;</span>
<span class="nc" id="L227">        return buildErrorResponse(ex, ex.getErrorCode(), userMessage, HttpStatus.SERVICE_UNAVAILABLE, null);</span>
    }

    /**
     * Handle database operation exceptions
     */
    @ExceptionHandler(DatabaseOperationException.class)
    public ResponseEntity&lt;ApiResponse&lt;Void&gt;&gt; handleDatabaseOperationException(
            DatabaseOperationException ex, WebRequest request) {
<span class="nc bnc" id="L236" title="All 2 branches missed.">        String userMessage = &quot;development&quot;.equals(environment) </span>
<span class="nc" id="L237">            ? ex.getMessage() </span>
<span class="nc" id="L238">            : &quot;Data operation failed, please try again later&quot;;</span>
<span class="nc" id="L239">        return buildErrorResponse(ex, ex.getErrorCode(), userMessage, HttpStatus.INTERNAL_SERVER_ERROR, null);</span>
    }

    /**
     * Handle resource not found exceptions
     */
    @ExceptionHandler(ResourceNotFoundException.class)
    public ResponseEntity&lt;ApiResponse&lt;Void&gt;&gt; handleResourceNotFoundException(
            ResourceNotFoundException ex, WebRequest request) {
<span class="nc" id="L248">        return buildErrorResponse(ex, ex.getErrorCode(), ex.getMessage(), HttpStatus.NOT_FOUND, null);</span>
    }

    /**
     * Handle duplicate resource exceptions
     */
    @ExceptionHandler(DuplicateResourceException.class)
    public ResponseEntity&lt;ApiResponse&lt;Void&gt;&gt; handleDuplicateResourceException(
            DuplicateResourceException ex, WebRequest request) {
<span class="nc" id="L257">        return buildErrorResponse(ex, ex.getErrorCode(), ex.getMessage(), HttpStatus.CONFLICT, null);</span>
    }

    /**
     * Handle business validation exceptions
     */
    @ExceptionHandler(BusinessValidationException.class)
    public ResponseEntity&lt;ApiResponse&lt;Map&lt;String, Object&gt;&gt;&gt; handleBusinessValidationException(
            BusinessValidationException ex, WebRequest request) {
<span class="nc" id="L266">        return buildErrorResponse(ex, ex.getErrorCode(), ex.getMessage(), HttpStatus.BAD_REQUEST, ex.getValidationDetails());</span>
    }

    /**
     * Handle data access exceptions
     */
    @ExceptionHandler(DataAccessException.class)
    public ResponseEntity&lt;ApiResponse&lt;Void&gt;&gt; handleDataAccessException(
            DataAccessException ex, WebRequest request) {
<span class="nc bnc" id="L275" title="All 2 branches missed.">        String userMessage = &quot;development&quot;.equals(environment) </span>
<span class="nc" id="L276">            ? &quot;Database access error: &quot; + ex.getMessage() </span>
<span class="nc" id="L277">            : &quot;Data access error, please try again later&quot;;</span>
<span class="nc" id="L278">        return buildErrorResponse(ex, &quot;DATA_ACCESS_ERROR&quot;, userMessage, HttpStatus.INTERNAL_SERVER_ERROR, null);</span>
    }

    /**
     * Handle data integrity violation exceptions
     */
    @ExceptionHandler(DataIntegrityViolationException.class)
    public ResponseEntity&lt;ApiResponse&lt;Void&gt;&gt; handleDataIntegrityViolationException(
            DataIntegrityViolationException ex, WebRequest request) {
<span class="nc" id="L287">        String userMessage = &quot;Data integrity constraint violation. Please check your input data.&quot;;</span>
<span class="nc bnc" id="L288" title="All 2 branches missed.">        if (&quot;development&quot;.equals(environment)) {</span>
<span class="nc" id="L289">            userMessage += &quot; Details: &quot; + ex.getMessage();</span>
        }
<span class="nc" id="L291">        return buildErrorResponse(ex, &quot;DATA_INTEGRITY_ERROR&quot;, userMessage, HttpStatus.BAD_REQUEST, null);</span>
    }

    /**
     * Handle HTTP method not supported exceptions
     */
    @ExceptionHandler(HttpRequestMethodNotSupportedException.class)
    public ResponseEntity&lt;ApiResponse&lt;Void&gt;&gt; handleHttpRequestMethodNotSupportedException(
            HttpRequestMethodNotSupportedException ex, WebRequest request) {
<span class="nc" id="L300">        String supportedMethods = String.join(&quot;, &quot;, ex.getSupportedMethods());</span>
<span class="nc" id="L301">        String message = String.format(&quot;HTTP method '%s' is not supported. Supported methods: %s&quot;, </span>
<span class="nc" id="L302">                                     ex.getMethod(), supportedMethods);</span>
<span class="nc" id="L303">        return buildErrorResponse(ex, &quot;METHOD_NOT_SUPPORTED&quot;, message, HttpStatus.METHOD_NOT_ALLOWED, null);</span>
    }

    /**
     * Handle missing request parameter exceptions
     */
    @ExceptionHandler(MissingServletRequestParameterException.class)
    public ResponseEntity&lt;ApiResponse&lt;Void&gt;&gt; handleMissingServletRequestParameterException(
            MissingServletRequestParameterException ex, WebRequest request) {
<span class="nc" id="L312">        String message = String.format(&quot;Required parameter '%s' of type '%s' is missing&quot;, </span>
<span class="nc" id="L313">                                     ex.getParameterName(), ex.getParameterType());</span>
<span class="nc" id="L314">        return buildErrorResponse(ex, &quot;MISSING_PARAMETER&quot;, message, HttpStatus.BAD_REQUEST, null);</span>
    }

    /**
     * Handle base business exceptions
     */
    @ExceptionHandler(BaseBusinessException.class)
    public ResponseEntity&lt;ApiResponse&lt;Void&gt;&gt; handleBaseBusinessException(
            BaseBusinessException ex, WebRequest request) {
<span class="nc" id="L323">        return buildErrorResponse(ex, ex.getErrorCode(), ex.getMessage(), HttpStatus.BAD_REQUEST, null);</span>
    }


    /**
     * Handle all other uncaught exceptions
     */
    @ExceptionHandler(Exception.class)
    public ResponseEntity&lt;ApiResponse&lt;Void&gt;&gt; handleGlobalException(
            Exception ex, WebRequest request) {
<span class="nc bnc" id="L333" title="All 2 branches missed.">        String userMessage = &quot;development&quot;.equals(environment) </span>
<span class="nc" id="L334">            ? &quot;System error: &quot; + ex.getMessage()</span>
<span class="nc" id="L335">            : &quot;Internal server error, please try again later&quot;;</span>
<span class="nc" id="L336">        return buildErrorResponse(ex, &quot;SYSTEM_ERROR&quot;, userMessage, HttpStatus.INTERNAL_SERVER_ERROR, null);</span>
    }
    
}
</pre><div class="footer"><span class="right">Created with <a href="http://www.jacoco.org/jacoco">JaCoCo</a> 0.8.11.202310140853</span></div></body></html>